// ğŸ…¾ï¸ TÃªn file: Slow_fixed.js
// PhiÃªn báº£n Ä‘Ã£ sá»­a lá»—i logic vÃ  tá»‘i Æ°u hÃ³a

import http from 'k6/http';
import { check, group, sleep } from 'k6';
import { html } from 'k6/html';

// --- Cáº¤U HÃŒNH ---
const BASE_URL = __ENV.TARGET_URL || 'https://certapple.com';
const PROXY_FILE_URL = 'https://raw.githubusercontent.com/Thuongquanggg/Proxy/main/proxies.txt';

// --- BIáº¾N TOÃ€N Cá»¤C ---
const USER_AGENTS = [
'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Firefox/115.0',
'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/114.0.1823.51',
'Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Mobile/15E148 Safari/604.1',
'Mozilla/5.0 (Linux; Android 13; SM-S908U) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Mobile Safari/537.36'
];

// --- CÃC HÃ€M LIÃŠN QUAN Äáº¾N PROXY ---
// HÃ m nÃ y chá»‰ nÃªn Ä‘Æ°á»£c gá»i tá»« setup() Ä‘á»ƒ trÃ¡nh tÃ¬nh tráº¡ng "thundering herd"
function fetchProxies() {
console.log('Äang láº¥y danh sÃ¡ch proxy tá»« GitHub...');
const res = http.get(PROXY_FILE_URL, { timeout: '30s' });
if (res.status === 200 && res.body) {
const allNewProxies = res.body.trim().split('\n').filter(p => p.trim() !== '');
if (allNewProxies.length > 0) {
const newProxies = allNewProxies.slice(0, 100); // Giá»›i háº¡n 100 proxy
console.log(`Láº¥y thÃ nh cÃ´ng ${newProxies.length} proxy.`);
return newProxies;
} else {
console.warn('File proxy.txt trÃªn GitHub rá»—ng hoáº·c khÃ´ng cÃ³ proxy há»£p lá»‡.');
}
} else {
console.error(`KhÃ´ng thá»ƒ láº¥y proxy tá»« GitHub. Status: ${res.status}`);
}
return []; // Tráº£ vá» máº£ng rá»—ng náº¿u tháº¥t báº¡i
}

// --- Cáº¤U HÃŒNH Ká»ŠCH Báº¢N TEST ---
export const options = {
insecureSkipTLSVerify: true,
scenarios: {
daily_traffic_simulation: {
executor: 'ramping-vus',
startTime: '0s',
// Sá»¬A Láº I STAGES Há»¢P LÃ HÆ N: TÄƒng táº£i tá»« tá»«, giá»¯ á»•n Ä‘á»‹nh, vÃ  giáº£m táº£i
stages: [
{ duration: '10s', target: 500 },  
{ duration: '20', target: 1000 },  
{ duration: '1m', target: 2000 }, 
{ duration: '10m', target: 2000 },
{ duration: '2m', target: 2000 },   
{ duration: '2m', target: 2000 },  
{ duration: '5m', target: 2000 },  
{ duration: '2m', target: 2000 }, 
{ duration: '6000m', target: 2000 },

],
gracefulStop: '2m',
exec: 'runTest', // Äáº·t tÃªn cho hÃ m thá»±c thi chÃ­nh Ä‘á»ƒ rÃµ rÃ ng
},
},
thresholds: {
'http_req_duration{type:html}': ['p(95)<5000'],
'http_req_duration{type:asset}': ['p(95)<3000'],
'http_req_failed': ['rate<0.30'],
'checks': ['rate>0.70'],
},
};

// --- SETUP FUNCTION ---
// Cháº¡y 1 láº§n duy nháº¥t trÆ°á»›c khi cÃ¡c VUs báº¯t Ä‘áº§u. LÃ½ tÆ°á»Ÿng Ä‘á»ƒ láº¥y dá»¯ liá»‡u dÃ¹ng chung.
export function setup() {
console.log('--- Báº¯t Ä‘áº§u pha SETUP ---');
const initialProxies = fetchProxies();
if (initialProxies.length === 0) {
// Náº¿u khÃ´ng láº¥y Ä‘Æ°á»£c proxy, ká»‹ch báº£n sáº½ vÃ´ nghÄ©a. Dá»«ng test táº¡i Ä‘Ã¢y.
throw new Error('KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch proxy ban Ä‘áº§u. Dá»«ng ká»‹ch báº£n.');
}
console.log(`--- SETUP hoÃ n táº¥t, láº¥y Ä‘Æ°á»£c ${initialProxies.length} proxy ---`);
// Dá»¯ liá»‡u tráº£ vá» tá»« setup sáº½ Ä‘Æ°á»£c truyá»n vÃ o hÃ m thá»±c thi chÃ­nh cá»§a má»—i VU
return { proxies: initialProxies };
}

// --- ÄIá»‚M VÃ€O CHÃNH (MAIN VU FUNCTION) ---
// TÃªn hÃ m khá»›p vá»›i 'exec' trong options.
// 'data' lÃ  Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tráº£ vá» tá»« hÃ m setup().
export function runTest(data) {
// Má»—i VU sáº½ nháº­n Ä‘Æ°á»£c cÃ¹ng má»™t danh sÃ¡ch proxy tá»« 'data'
const proxyPool = data.proxies;

// Logic chá»n hÃ nh vi ngÆ°á»i dÃ¹ng
const random = Math.random();
if (random < 0.2) {
firstTimeVisitor(proxyPool);
} else if (random < 0.4) {
returningVisitor(proxyPool);
} else {
chaoticBrowser(proxyPool);
}
}

// --- CÃC HÃ€M MÃ” PHá»NG HÃ€NH VI ---
// (KhÃ´ng cÃ³ thay Ä‘á»•i trong cÃ¡c hÃ m bÃªn dÆ°á»›i)

function firstTimeVisitor(proxies) {
const params = getBaseParams(proxies);
group('HÃ nh vi: KhÃ¡ch láº§n Ä‘áº§u', function () {
const res = http.get(BASE_URL, { ...params, tags: { type: 'html' } });
const isStatusOk = check(res, { 'Trang chá»§ OK': (r) => r && r.status === 200 });
if (isStatusOk) {
if (res.body) {
loadPageAssets(res, params, null);
} else {
console.error(`Pháº£n há»“i rá»—ng tá»« ${BASE_URL}`);
}
}
});
sleep(Math.random() * 4 + 3);
}

const vuCache = new Map();

function returningVisitor(proxies) {
const params = getBaseParams(proxies);
group('HÃ nh vi: KhÃ¡ch quay láº¡i', function () {
const res = http.get(BASE_URL, { ...params, tags: { type: 'html' } });
const isStatusOk = check(res, { 'Trang chá»§ OK': (r) => r && r.status === 200 });
if (isStatusOk) {
if (res.body) {
loadPageAssets(res, params, vuCache);
} else {
console.error(`Pháº£n há»“i rá»—ng tá»« ${BASE_URL}`);
}
}
});
sleep(Math.random() * 4 + 3);
}

const internalLinks = new Set([BASE_URL]);

function chaoticBrowser(proxies) {
const params = getBaseParams(proxies);
group('HÃ nh vi: NgÆ°á»i dÃ¹ng Ä‘i dáº¡o', function () {
const linksArray = Array.from(internalLinks);
const currentUrl = linksArray.length > 0 ? linksArray[Math.floor(Math.random() * linksArray.length)] : BASE_URL;
const res = http.get(currentUrl, { ...params, tags: { type: 'html' } });
const isStatusOk = check(res, { 'Táº£i trang OK': (r) => r && r.status === 200 });
if (isStatusOk) {
if (res.body) {
const discoveredLinks = loadPageAssets(res, params, null);
discoveredLinks.forEach(link => internalLinks.add(link));
} else {
console.error(`Pháº£n há»“i rá»—ng tá»« ${currentUrl}`);
}
}
});
sleep(Math.random() * 5 + 4);
}

// --- CÃC HÃ€M Há»– TRá»¢ ---
// (KhÃ´ng cÃ³ thay Ä‘á»•i trong cÃ¡c hÃ m bÃªn dÆ°á»›i)

function getBaseParams(proxyPool) {
const params = {
headers: {
'User-Agent': USER_AGENTS[__VU % USER_AGENTS.length],
'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
'Accept-Language': 'en-US,en;q=0.5',
'Accept-Encoding': 'gzip, deflate, br',
},
};

if (proxyPool && proxyPool.length > 0) {
// Má»—i VU sáº½ chá»n má»™t proxy dá»±a trÃªn ID cá»§a nÃ³ (__VU)
params.proxy = proxyPool[__VU % proxyPool.length];
} else {
// TrÆ°á»ng há»£p nÃ y khÃ´ng nÃªn xáº£y ra do Ä‘Ã£ cÃ³ kiá»ƒm tra trong setup()
console.warn(`[VU=${__VU}] Bá»ƒ proxy rá»—ng. Request sáº½ Ä‘Æ°á»£c gá»­i khÃ´ng qua proxy.`);
}
return params;
}

function loadPageAssets(res, params, cache) {
const discoveredLinks = new Set();
if (!res || !res.body) {
console.error(`Pháº£n há»“i khÃ´ng há»£p lá»‡: ${JSON.stringify(res)}`);
return Array.from(discoveredLinks);
}

const doc = html.parse(res.body);
const assetUrls = new Set();

doc.find('link[href], script[src], img[src], video[src], audio[src], source[src]').each((_, el) => {
const url = el.attr('href') || el.attr('src');
if (url) assetUrls.add(resolveUrl(url, res.url));
});

const contentType = res.headers['Content-Type'];
const isCssResponse = contentType && contentType.includes('css');
const cssBody = doc.find('style').text() + (isCssResponse ? res.body : '');
const cssUrls = cssBody.match(/url\(['"]?([^'")]+)['"]?\)/g) || [];
cssUrls.forEach(match => {
const url = match.replace(/url\(['"]?/, '').replace(/['"]?\)/, '');
if (url && !url.startsWith('data:')) {
assetUrls.add(resolveUrl(url, res.url));
}
});

doc.find('a[href]').each((_, el) => {
const link = el.attr('href');
if (link) {
const resolvedLink = resolveUrl(link, res.url);
if (resolvedLink && resolvedLink.startsWith(BASE_URL) && !resolvedLink.match(/\.(jpg|jpeg|png|gif|css|js|pdf)$/i) && !resolvedLink.includes('#')) {
discoveredLinks.add(resolvedLink);
}
}
});

const requests = [];
assetUrls.forEach(url => {
if (url) {
const assetParams = { ...params, tags: { type: 'asset' } };
if (cache && cache.has(url)) {
assetParams.headers['If-None-Match'] = cache.get(url);
}
requests.push(['GET', url, null, assetParams]);
}
});

if (requests.length > 0) {
const responses = http.batch(requests);
if (cache) {
responses.forEach((r, i) => {
const url = requests[i][1];
if (r && r.status === 200 && r.headers['Etag']) {
cache.set(url, r.headers['Etag']);
}
if (r) {
check(r, { 'TÃ i nguyÃªn cache há»£p lá»‡ (200 hoáº·c 304)': (res) => [200, 304].includes(res.status) });
}
});
}
}
return Array.from(discoveredLinks);
}

function resolveUrl(url, pageUrl) {
try {
return (new URL(url, pageUrl)).href;
} catch (e) {
console.warn(`URL khÃ´ng há»£p lá»‡: "${url}" trÃªn trang ${pageUrl}`);
return '';
}
}
