
// ğŸ…¾ï¸ TÃªn file: Human_Emulator (js)
import { browser } from 'k6/browser';
import { check, group, sleep, fail } from 'k6';

// --- Cáº¤U HÃŒNH NÃ‚NG CAO ---
const BASE_URL = __ENV.TARGET_URL || 'https://certapple.com';

// THAY Äá»”I QUAN TRá»ŒNG: Sá»­ dá»¥ng Proxy DÃ¢n CÆ° hoáº·c Proxy cháº¥t lÆ°á»£ng cao
// ÄÃ¢y lÃ  Ä‘á»‹nh dáº¡ng vÃ­ dá»¥, báº¡n cáº§n thay Ä‘á»•i theo nhÃ  cung cáº¥p proxy cá»§a mÃ¬nh.
// Náº¿u khÃ´ng cÃ³, hÃ£y Ä‘á»ƒ lÃ  null Ä‘á»ƒ cháº¡y khÃ´ng qua proxy.
const RESIDENTIAL_PROXY_ENDPOINT = __ENV.PROXY || null; // vÃ­ dá»¥: 'http://user-xyz:pass123@proxy.provider.com:8080'

// --- Cáº¤U HÃŒNH Ká»ŠCH Báº¢N TEST ---
export const options = {
    scenarios: {
        // Ká»‹ch báº£n nÃ y dÃ¹ng trÃ¬nh duyá»‡t nÃªn tá»‘n tÃ i nguyÃªn hÆ¡n
        browser_based_load: {
            executor: 'ramping-vus',
            startTime: '0s',
            stages: [
                { duration: '30s', target: 10 }, // TÄƒng tá»« tá»« lÃªn 10 ngÆ°á»i dÃ¹ng trÃ¬nh duyá»‡t
                { duration: '5m', target: 10 },  // Giá»¯ 10 ngÆ°á»i dÃ¹ng trong 5 phÃºt
                { duration: '10m', target: 20 }, // TÄƒng lÃªn 20 ngÆ°á»i dÃ¹ng
                { duration: '30m', target: 20 }, // Giá»¯ 20 ngÆ°á»i dÃ¹ng trong 30 phÃºt
            ],
            gracefulStop: '1m',
            exec: 'main',
        },
    },
    thresholds: {
        'browser_web_vital_lcp': ['p(95) < 4000'], // Largest Contentful Paint dÆ°á»›i 4s
        'browser_web_vital_fid': ['p(95) < 100'],  // First Input Delay dÆ°á»›i 100ms
        'checks': ['rate>0.90'], // Tá»· lá»‡ check thÃ nh cÃ´ng pháº£i cao
    },
};

// --- ÄIá»‚M VÃ€O CHÃNH (MAIN VU FUNCTION) ---
// HÃ m chÃ­nh giá» lÃ  async vÃ¬ cÃ¡c thao tÃ¡c trÃªn trÃ¬nh duyá»‡t lÃ  báº¥t Ä‘á»“ng bá»™
export async function main() {
    const browserOptions = {
        headless: true, // Cháº¡y á»Ÿ cháº¿ Ä‘á»™ khÃ´ng giao diá»‡n Ä‘á»ƒ tiáº¿t kiá»‡m tÃ i nguyÃªn
    };

    // Cáº¥u hÃ¬nh proxy cho trÃ¬nh duyá»‡t náº¿u cÃ³
    if (RESIDENTIAL_PROXY_ENDPOINT) {
        browserOptions.proxy = {
            server: RESIDENTIAL_PROXY_ENDPOINT,
        };
    }

    // Khá»Ÿi cháº¡y má»™t trÃ¬nh duyá»‡t má»›i cho má»—i VU
    const context = await browser.newContext(browserOptions);
    const page = await context.newPage();

    try {
        await group('HÃ nh vi: NgÆ°á»i dÃ¹ng thÃ´ng minh truy cáº­p trang', async () => {
            // 1. Truy cáº­p trang chá»§
            console.log(`[VU=${__VU}] Äang truy cáº­p ${BASE_URL}...`);
            const res = await page.goto(BASE_URL, { waitUntil: 'domcontentloaded' });
            check(res, { 'Trang chá»§ táº£i thÃ nh cÃ´ng (status 200-299)': (r) => r.ok() });

            // 2. MÃ” PHá»NG HÃ€NH VI CON NGÆ¯á»œI
            await simulateHumanBehavior(page);

            // 3. TÃ¬m vÃ  click vÃ o má»™t liÃªn káº¿t ngáº«u nhiÃªn
            const links = await page.locator('a[href^="/"]'); // TÃ¬m cÃ¡c liÃªn káº¿t ná»™i bá»™
            const count = await links.count();
            if (count > 0) {
                const randomIndex = Math.floor(Math.random() * count);
                const randomLink = links.nth(randomIndex);
                const linkText = await randomLink.textContent();
                
                console.log(`[VU=${__VU}] TÃ¬m tháº¥y ${count} liÃªn káº¿t, click vÃ o: "${linkText.trim()}"`);
                
                // Click vÃ  chá» trang má»›i táº£i xong
                await Promise.all([
                    page.waitForNavigation(),
                    randomLink.click(),
                ]);

                check(page, { 'Chuyá»ƒn trang thÃ nh cÃ´ng': (p) => p.url() !== BASE_URL });
                
                // 4. Láº¡i mÃ´ phá»ng hÃ nh vi trÃªn trang má»›i
                await simulateHumanBehavior(page);
            } else {
                console.log(`[VU=${__VU}] KhÃ´ng tÃ¬m tháº¥y liÃªn káº¿t ná»™i bá»™ nÃ o Ä‘á»ƒ click.`);
            }
        });
    } finally {
        // ÄÃ³ng trang vÃ  trÃ¬nh duyá»‡t Ä‘á»ƒ giáº£i phÃ³ng tÃ i nguyÃªn
        await page.close();
        await context.close();
    }
}

// HÃ€M Má»šI: MÃ´ phá»ng cÃ¡c hÃ nh Ä‘á»™ng giá»‘ng ngÆ°á»i tháº­t
async function simulateHumanBehavior(page) {
    // Chá» má»™t chÃºt nhÆ° ngÆ°á»i dÃ¹ng Ä‘ang Ä‘á»c
    await sleep(Math.random() * 3 + 2); // Chá» 2-5 giÃ¢y

    // Di chuyá»ƒn chuá»™t Ä‘áº¿n cÃ¡c vá»‹ trÃ­ ngáº«u nhiÃªn
    console.log(`[VU=${__VU}] MÃ´ phá»ng di chuyá»ƒn chuá»™t...`);
    for (let i = 0; i < 3; i++) {
        await page.mouse.move(
            Math.random() * page.viewportSize().width,
            Math.random() * page.viewportSize().height
        );
        await sleep(Math.random() * 0.5 + 0.2); // Chá» 0.2-0.7 giÃ¢y
    }

    // Cuá»™n trang xuá»‘ng má»™t cÃ¡ch ngáº«u nhiÃªn
    console.log(`[VU=${__VU}] MÃ´ phá»ng cuá»™n trang...`);
    const scrollAmount = Math.random() * 500 + 300; // Cuá»™n 300-800 pixels
    await page.evaluate((amount) => window.scrollBy(0, amount), scrollAmount);
    
    // Chá» thÃªm má»™t chÃºt trÆ°á»›c khi káº¿t thÃºc
    await sleep(Math.random() * 2 + 1); // Chá» 1-3 giÃ¢y
}
