
// ğŸ…¾ï¸ TÃªn file: ghost_v2.js
// MÃ£ Ká»‹ch Báº£n NÃ¢ng Cáº¥p: â€œGhost in the Machine 2.0â€
// Má»¥c tiÃªu: MÃ´ phá»ng hÃ nh vi ngÆ°á»i dÃ¹ng má»™t cÃ¡ch cá»±c ká»³ tinh vi Ä‘á»ƒ vÆ°á»£t qua cÃ¡c lá»›p phÃ²ng thá»§
// WAF/CDN nÃ¢ng cao vÃ  kiá»ƒm tra sÃ¢u logic nghiá»‡p vá»¥ cá»§a á»©ng dá»¥ng.
//
// CÃ¡c cáº£i tiáº¿n chÃ­nh:
// 1. Táº£i tÃ i nguyÃªn tÄ©nh (CSS, JS) Ä‘á»ƒ giáº£ láº­p trÃ¬nh duyá»‡t hoÃ n chá»‰nh.
// 2. TÆ°Æ¡ng tÃ¡c dá»±a trÃªn ná»™i dung: PhÃ¢n tÃ­ch HTML Ä‘á»ƒ click vÃ o link ngáº«u nhiÃªn.
// 3. "Thá»i gian suy nghÄ©": ThÃªm cÃ¡c khoáº£ng nghá»‰ nhá» giá»¯a cÃ¡c hÃ nh Ä‘á»™ng.
// 4. Bá»ƒ dá»¯ liá»‡u Ä‘a dáº¡ng cho cáº£ ngÆ°á»i dÃ¹ng vÃ  tá»« khÃ³a tÃ¬m kiáº¿m.

import http from 'k6/http';
import { check, group, sleep } from 'k6';
import { html } from 'k6/html';
import { SharedArray } from 'k6/data';

// --- Cáº¤U HÃŒNH CHÃNH ---
const BASE_URL = 'https://nezushub.vip'; // Thay báº±ng trang cá»§a báº¡n

// --- Bá»‚ Dá»® LIá»†U NÃ‚NG CAO ---

// 1. Dá»¯ liá»‡u ngÆ°á»i dÃ¹ng Ä‘á»ƒ Ä‘Äƒng nháº­p (Ä‘á»c tá»« file JSON)
const users = new SharedArray('users', function () {
  try {
    return JSON.parse(open('./data/users.json'));
  } catch (e) {
    console.error("KhÃ´ng thá»ƒ Ä‘á»c file users.json. Ká»‹ch báº£n xÃ¡c thá»±c sáº½ cháº¡y nhÆ° khÃ¡ch.");
    return [];
  }
});

// 2. Dá»¯ liá»‡u tá»« khÃ³a tÃ¬m kiáº¿m (Ä‘á»c tá»« file JSON)
const searchTerms = new SharedArray('search-terms', function () {
  try {
    return JSON.parse(open('./data/search_terms.json'));
  } catch (e) {
    console.error("KhÃ´ng thá»ƒ Ä‘á»c file search_terms.json. Sáº½ dÃ¹ng tá»« khÃ³a máº·c Ä‘á»‹nh.");
    return ['test'];
  }
});

// 3. Bá»ƒ User-Agents vÃ  Headers phá»©c táº¡p
const BROWSER_PROFILES = [
  {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
    'Accept-Language': 'en-US,en;q=0.9,vi;q=0.8',
    'Sec-CH-UA': '"Not.A/Brand";v="8", "Chromium";v="114", "Google Chrome";v="114"',
    'Sec-CH-UA-Mobile': '?0',
    'Sec-CH-UA-Platform': '"Windows"',
  },
  {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Firefox/115.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'fr-FR,fr;q=0.8,en-US;q=0.5,en;q=0.3',
  }
];

// --- Cáº¤U HÃŒNH Ká»ŠCH Báº¢N TEST (SCENARIOS) ---
export const options = {
  scenarios: {
    guest_browsing: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '5m', target: 60 }, // 60% cá»§a 100 VUs
        { duration: '30m', target: 60 },
        { duration: '5m', target: 0 },
      ],
      exec: 'guestBehavior',
    },
    authenticated_user: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '5m', target: 40 }, // 40% cá»§a 100 VUs
        { duration: '30m', target: 40 },
        { duration: '5m', target: 0 },
      ],
      exec: 'authenticatedBehavior',
    },
  },
  thresholds: {
    'http_req_duration': ['p(95)<2500'],
    'http_req_failed': ['rate<0.02'],
    'checks': ['rate>0.98'],
  },
};

// --- CÃC HÃ€NH VI CHÃNH ---

// HÃ nh vi cá»§a khÃ¡ch vÃ£ng lai
export function guestBehavior() {
  const params = getBaseParams();
  group('HÃ nh vi: KhÃ¡ch vÃ£ng lai', function () {
    // 1. Táº£i trang chá»§
    const res = http.get(BASE_URL, { ...params, tags: { name: 'HomePage' } });
    check(res, { 'Trang chá»§ OK': (r) => r.status === 200 });

    if (res.status === 200) {
      // 2. MÃ´ phá»ng trÃ¬nh duyá»‡t táº£i cÃ¡c tÃ i nguyÃªn tÄ©nh
      loadStaticAssets(res, params);

      // 3. "Thá»i gian suy nghÄ©" - ngÆ°á»i dÃ¹ng Ä‘á»c trang
      sleep(Math.random() * 3 + 1); // 1-4 giÃ¢y

      // 4. TÆ°Æ¡ng tÃ¡c ngáº«u nhiÃªn: Hoáº·c click link, hoáº·c tÃ¬m kiáº¿m
      const doc = html.parse(res.body);
      const internalLinks = doc.find('a[href^="/"]');

      if (Math.random() < 0.7 && internalLinks.length > 0) {
        // 70% cÆ¡ há»™i sáº½ click vÃ o má»™t link ngáº«u nhiÃªn trÃªn trang
        const randomLink = internalLinks.get(Math.floor(Math.random() * internalLinks.length));
        const nextUrl = randomLink.attr('href');
        
        if (nextUrl) {
          const browseRes = http.get(`${BASE_URL}${nextUrl}`, { ...params, tags: { name: 'BrowsePage' } });
          check(browseRes, { 'Duyá»‡t trang con OK': (r) => r.status === 200 });
        }
      } else {
        // 30% cÆ¡ há»™i sáº½ thá»±c hiá»‡n tÃ¬m kiáº¿m
        const term = searchTerms[Math.floor(Math.random() * searchTerms.length)];
        const searchRes = http.get(`${BASE_URL}/search?q=${encodeURIComponent(term)}`, { ...params, tags: { name: 'Search' } });
        check(searchRes, { 'Trang tÃ¬m kiáº¿m OK': (r) => r.status === 200 });
      }
    }
  });
  sleep(Math.random() * 5 + 5); // Nghá»‰ 5-10 giÃ¢y trÆ°á»›c khi báº¯t Ä‘áº§u vÃ²ng láº·p má»›i
}

// HÃ nh vi cá»§a ngÆ°á»i dÃ¹ng Ä‘Ã£ xÃ¡c thá»±c
export function authenticatedBehavior() {
  const user = users[__VU % users.length];
  if (!user) {
    guestBehavior(); // Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u user, hoáº¡t Ä‘á»™ng nhÆ° khÃ¡ch
    return;
  }
  
  const params = getBaseParams();
  group('HÃ nh vi: NgÆ°á»i dÃ¹ng xÃ¡c thá»±c', function () {
    // 1. ÄÄƒng nháº­p
    const loggedIn = login(user.username, user.password, params);

    if (loggedIn) {
      // 2. "Thá»i gian suy nghÄ©" sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
      sleep(Math.random() * 2 + 1); // 1-3 giÃ¢y

      // 3. Xem trang cÃ¡ nhÃ¢n
      const profileRes = http.get(`${BASE_URL}/my-account`, { ...params, tags: { name: 'MyAccount' } });
      check(profileRes, { 'Xem trang cÃ¡ nhÃ¢n OK': (r) => r.status === 200 && r.body.includes(user.username) });

      if (profileRes.status === 200) {
        // 4. "Thá»i gian suy nghÄ©" trÆ°á»›c khi thá»±c hiá»‡n hÃ nh Ä‘á»™ng tiáº¿p theo
        sleep(Math.random() * 3 + 2); // 2-5 giÃ¢y

        // 5. Gá»i má»™t API ná»™i bá»™, vÃ­ dá»¥: láº¥y danh sÃ¡ch Ä‘Æ¡n hÃ ng
        const apiRes = http.get(`${BASE_URL}/api/v1/orders`, { ...params, tags: { name: 'GetOrdersAPI' } });
        check(apiRes, { 'API láº¥y Ä‘Æ¡n hÃ ng OK': (r) => r.status === 200 });
      }
    }
  });

  sleep(Math.random() * 8 + 7); // NgÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p thÆ°á»ng á»Ÿ láº¡i lÃ¢u hÆ¡n, 7-15 giÃ¢y
}

// --- CÃC HÃ€M Há»– TRá»¢ ---

// HÃ m Ä‘Äƒng nháº­p, láº¥y CSRF token vÃ  tráº£ vá» true/false
function login(username, password, params) {
  let csrfToken = '';
  
  // BÆ°á»›c 1: Táº£i trang Ä‘Äƒng nháº­p Ä‘á»ƒ láº¥y CSRF token tá»« form
  const loginPageRes = http.get(`${BASE_URL}/login`, params);
  if (loginPageRes.status === 200) {
    const doc = html.parse(loginPageRes.body);
    csrfToken = doc.find('input[name="_csrf"]').attr('value');
  }
  check(loginPageRes, { 'Táº£i trang Ä‘Äƒng nháº­p OK': (r) => r.status === 200 && csrfToken !== '' });

  if (!csrfToken) {
    console.error('KhÃ´ng tÃ¬m tháº¥y CSRF token trÃªn trang Ä‘Äƒng nháº­p.');
    return false;
  }

  // BÆ°á»›c 2: Gá»­i request POST Ä‘á»ƒ Ä‘Äƒng nháº­p
  const loginPayload = { username, password, _csrf: csrfToken };
  const loginRes = http.post(`${BASE_URL}/login`, loginPayload, params);
  
  // k6 sáº½ tá»± Ä‘á»™ng xá»­ lÃ½ redirect, nÃªn ta check trang sau redirect
  const loggedInSuccess = check(loginRes, {
    'ÄÄƒng nháº­p thÃ nh cÃ´ng': (r) => r.status === 200 && r.url.includes('/my-account'), // VÃ­ dá»¥: redirect tá»›i trang cÃ¡ nhÃ¢n
    'Cookie session Ä‘Æ°á»£c thiáº¿t láº­p': (r) => r.cookies.sessionid !== undefined,
  });

  return loggedInSuccess;
}

// HÃ m mÃ´ phá»ng táº£i cÃ¡c tÃ i nguyÃªn tÄ©nh
function loadStaticAssets(res, params) {
    const doc = html.parse(res.body);
    const requests = [];
    // TÃ¬m 2 file CSS vÃ  2 file JS Ä‘á»ƒ táº£i
    doc.find('link[rel="stylesheet"]').slice(0, 2).each((i, el) => {
        requests.push(['GET', res.url.resolve(el.attr('href')), params]);
    });
    doc.find('script[src]').slice(0, 2).each((i, el) => {
        requests.push(['GET', res.url.resolve(el.attr('src')), params]);
    });
    
    if (requests.length > 0) {
        http.batch(requests);
    }
}

// HÃ m táº¡o header ngáº«u nhiÃªn tá»« profile trÃ¬nh duyá»‡t
function getBaseParams() {
  const profile = BROWSER_PROFILES[Math.floor(Math.random() * BROWSER_PROFILES.length)];
  return {
    headers: profile,
  };
}
