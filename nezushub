
// ğŸ…¾ï¸ TÃªn file: xenforo_attacker (js)
// Ká»‹ch báº£n kiá»ƒm thá»­ hiá»‡u nÄƒng chuyÃªn dá»¥ng cho diá»…n Ä‘Ã n XenForo (nezushub.vip).
// MÃ´ phá»ng hÃ nh vi ngÆ°á»i dÃ¹ng thá»±c táº¿, bao gá»“m xá»­ lÃ½ CSRF token.

import http from 'k6/http';
import { check, group, sleep } from 'k6';
import { html } from 'k6/html';
import { SharedArray } from 'k6/data';

// --- Cáº¤U HÃŒNH ---
const BASE_URL = 'https://nezushub.vip';

// Dá»¯ liá»‡u ngÆ°á»i dÃ¹ng Ä‘á»ƒ Ä‘Äƒng nháº­p (Táº O FILE data/users.json)
// Äá»‹nh dáº¡ng: [ { "username": "user1", "password": "password1" } ]
const users = new SharedArray('users', function () {
  try {
    return JSON.parse(open('./data/users.json'));
  } catch (e) {
    console.error("KhÃ´ng tÃ¬m tháº¥y file data/users.json, ká»‹ch báº£n Ä‘Äƒng nháº­p sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.");
    return [];
  }
});

// --- Cáº¤U HÃŒNH Ká»ŠCH Báº¢N TEST ---
export const options = {
  scenarios: {
    // 70% lÃ  khÃ¡ch, chá»‰ xem vÃ  tÃ¬m kiáº¿m
    guest_users: {
      executor: 'ramping-vus',
      stages: [
        { duration: '2m', target: 15 },
        { duration: '5m', target: 35 },
        { duration: '10m', target: 35 },
        { duration: '3m', target: 0 },
      ],
      exec: 'guestScenario',
    },
    // 30% lÃ  thÃ nh viÃªn, sáº½ Ä‘Äƒng nháº­p vÃ  tÆ°Æ¡ng tÃ¡c
    member_users: {
      executor: 'ramping-vus',
      startTime: '1m', // Báº¯t Ä‘áº§u sau khÃ¡ch 1 phÃºt
      stages: [
        { duration: '2m', target: 5 },
        { duration: '5m', target: 15 },
        { duration: '10m', target: 15 },
        { duration: '3m', target: 0 },
      ],
      exec: 'memberScenario',
    },
  },
  thresholds: {
    'http_req_duration': ['p(95)<3500'],
    'http_req_failed': ['rate<0.03'],
    'checks': ['rate>0.97'],
  },
};

// --- HÃ€NH VI Cá»¦A KHÃCH (GUEST) ---
export function guestScenario() {
  group('HÃ nh vi: KhÃ¡ch vÃ£ng lai', function () {
    // 1. Táº£i trang chá»§ vÃ  láº¥y token
    const res = http.get(BASE_URL);
    check(res, { 'Trang chá»§ táº£i thÃ nh cÃ´ng': (r) => r.status === 200 });
    const token = extractToken(res);

    if (token) {
      // 2. MÃ´ phá»ng tÃ¬m kiáº¿m (hÃ nh Ä‘á»™ng nÃ y gÃ¢y Ã¡p lá»±c lÃªn DB)
      const searchTerms = ['certificate', 'ipa library', 'tutorial', 'rules'];
      const term = searchTerms[Math.floor(Math.random() * searchTerms.length)];

      const searchRes = http.post(
        `${BASE_URL}/search/search`,
        {
          keywords: term,
          _xfToken: token,
        },
        { tags: { name: 'Search' } }
      );
      check(searchRes, { 'TÃ¬m kiáº¿m thÃ nh cÃ´ng': (r) => r.status === 200 });

      sleep(Math.random() * 3 + 2); // NghÄ© 2-5 giÃ¢y

      // 3. Xem má»™t diá»…n Ä‘Ã n ngáº«u nhiÃªn
      const doc = html.parse(res.body);
      const forumLinks = [];
      doc.find('h3.node-title a').each((_, el) => {
        const href = el.attr('href');
        if (href && href.startsWith('/forums/')) {
          forumLinks.push(href);
        }
      });

      if (forumLinks.length > 0) {
        const randomForum = forumLinks[Math.floor(Math.random() * forumLinks.length)];
        const forumRes = http.get(`${BASE_URL}${randomForum}`);
        check(forumRes, { 'Xem diá»…n Ä‘Ã n thÃ nh cÃ´ng': (r) => r.status === 200 });
      }
    }
  });
  sleep(Math.random() * 5 + 5); // Nghá»‰ 5-10 giÃ¢y trÆ°á»›c khi láº·p láº¡i
}

// --- HÃ€NH VI Cá»¦A THÃ€NH VIÃŠN (MEMBER) ---
export function memberScenario() {
  // Má»—i VU lÃ  má»™t ngÆ°á»i dÃ¹ng khÃ¡c nhau, cÃ³ cookie jar riÃªng.
  const user = users[__VU % users.length];
  if (!user) return; // Bá» qua náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u user

  group('HÃ nh vi: ThÃ nh viÃªn Ä‘Äƒng nháº­p', function () {
    // 1. Táº£i trang Ä‘Äƒng nháº­p Ä‘á»ƒ láº¥y token
    const loginPageRes = http.get(`${BASE_URL}/login/`);
    const token = extractToken(loginPageRes, 'form[action="/login/login"]');
    if (!token) {
      console.error('KhÃ´ng láº¥y Ä‘Æ°á»£c token Ä‘Äƒng nháº­p!');
      return;
    }

    // 2. Gá»­i request POST Ä‘á»ƒ Ä‘Äƒng nháº­p
    // k6 sáº½ tá»± Ä‘á»™ng quáº£n lÃ½ cookie session
    const loginRes = http.post(
      `${BASE_URL}/login/login`,
      {
        login: user.username,
        password: user.password,
        remember: 1,
        _xfToken: token,
      },
      { tags: { name: 'Login' } }
    );

    // XenForo redirect (303) sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
    const isLoggedIn = check(loginRes, {
      'ÄÄƒng nháº­p thÃ nh cÃ´ng (redirect)': (r) => r.status === 303,
      'Cookie session Ä‘Æ°á»£c thiáº¿t láº­p': (r) => r.cookies.xf_session !== undefined,
    });

    if (isLoggedIn) {
      // 3. Sau khi Ä‘Äƒng nháº­p, táº£i láº¡i trang chá»§ (trÃ¬nh duyá»‡t sáº½ lÃ m váº­y)
      const homeRes = http.get(BASE_URL);
      check(homeRes, { 'Táº£i trang chá»§ (Ä‘Ã£ Ä‘Äƒng nháº­p) OK': (r) => r.status === 200 && r.body.includes('Log out') });
      
      // 4. Láº¥y token má»›i tá»« trang chá»§ Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng khÃ¡c
      const newToken = extractToken(homeRes);
      
      // 5. Gá»­i má»™t tin nháº¯n vÃ o Shoutbox (hÃ nh Ä‘á»™ng AJAX)
      if (newToken) {
          const shoutRes = http.post(`${BASE_URL}/shoutbox/shout`, {
              message: `k6 user ${__VU} says hello!`,
              _xfToken: newToken
          }, { tags: { name: 'Shoutbox_Post' }});
          check(shoutRes, { 'Gá»­i tin shoutbox OK': (r) => r.status === 200 });
      }
    }
  });
  sleep(Math.random() * 10 + 8); // ThÃ nh viÃªn thÆ°á»ng á»Ÿ láº¡i lÃ¢u hÆ¡n
}

// --- HÃ€M Há»– TRá»¢ ---

// HÃ m cá»‘t lÃµi: TrÃ­ch xuáº¥t _xfToken tá»« HTML response
function extractToken(res, selector = 'input[name="_xfToken"]') {
  if (!res || !res.body) {
    return null;
  }
  const doc = html.parse(res.body);
  const tokenElement = doc.find(selector);
  if (tokenElement.length > 0) {
    return tokenElement.first().attr('value');
  }
  // Fallback: TÃ¬m trong tháº» meta
  const metaToken = doc.find('meta[name="csrf"]').attr('content');
  if (metaToken) {
      return metaToken;
  }
  return null;
}
