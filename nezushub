// ğŸ…¾ï¸ TÃªn file: nezushub (Ä‘Ã£ sá»­a lá»—i vÃ  nÃ¢ng cáº¥p)
// Ká»‹ch báº£n kiá»ƒm thá»­ hiá»‡u nÄƒng chuyÃªn dá»¥ng cho diá»…n Ä‘Ã n XenForo (nezushub.vip).
// PhiÃªn báº£n nÃ y "cá»©ng cÃ¡p" hÆ¡n, cÃ³ thá»ƒ xá»­ lÃ½ lá»—i káº¿t ná»‘i vÃ  bÃ¡o cÃ¡o chÃ­nh xÃ¡c.

import http from 'k6/http';
import { check, group, sleep } from 'k6';
import { html } from 'k6/html';
import { SharedArray } from 'k6/data';

// --- Cáº¤U HÃŒNH ---
const BASE_URL = 'https://nezushub.vip';

const users = new SharedArray('users', function () {
  try {
    return JSON.parse(open('./data/users.json'));
  } catch (e) {
    // Lá»—i nÃ y váº«n sáº½ xuáº¥t hiá»‡n náº¿u file khÃ´ng cÃ³, nhÆ°ng ká»‹ch báº£n sáº½ khÃ´ng crash
    console.error("Lá»—i Ä‘á»c file data/users.json. Ká»‹ch báº£n Ä‘Äƒng nháº­p sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.");
    return [];
  }
});

// --- Cáº¤U HÃŒNH Ká»ŠCH Báº¢N TEST ---
export const options = {
  scenarios: {
    guest_users: {
      executor: 'ramping-vus',
      stages: [
        { duration: '2m', target: 15 },
        { duration: '5m', target: 35 },
        { duration: '10m', target: 35 },
        { duration: '3m', target: 0 },
      ],
      exec: 'guestScenario',
    },
    member_users: {
      executor: 'ramping-vus',
      startTime: '1m',
      stages: [
        { duration: '2m', target: 5 },
        { duration: '5m', target: 15 },
        { duration: '10m', target: 15 },
        { duration: '3m', target: 0 },
      ],
      exec: 'memberScenario',
    },
  },
  thresholds: {
    'http_req_duration': ['p(95)<3500'],
    'http_req_failed': ['rate<0.03'],
    'checks': ['rate>0.97'],
  },
};

// --- HÃ€NH VI Cá»¦A KHÃCH (GUEST) ---
export function guestScenario() {
  group('HÃ nh vi: KhÃ¡ch vÃ£ng lai', function () {
    const res = http.get(BASE_URL, {
      // ThÃªm User-Agent Ä‘á»ƒ trÃ´ng giá»‘ng trÃ¬nh duyá»‡t hÆ¡n
      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36' }
    });

    // === ÄIá»‚M Sá»¬A Lá»–I QUAN TRá»ŒNG NHáº¤T ===
    // LuÃ´n kiá»ƒm tra xem request cÃ³ thÃ nh cÃ´ng khÃ´ng TRÆ¯á»šC KHI lÃ m báº¥t cá»© Ä‘iá»u gÃ¬ khÃ¡c.
    const isHomepageOk = check(res, { 'Trang chá»§ táº£i thÃ nh cÃ´ng (status 200)': (r) => r && r.status === 200 });

    // Náº¿u request tháº¥t báº¡i, dá»«ng ngay vÃ  bÃ¡o lá»—i.
    if (!isHomepageOk) {
      console.error(`Lá»—i nghiÃªm trá»ng: KhÃ´ng thá»ƒ táº£i trang chá»§. Status: ${res ? res.status : 'N/A'}. Bá» qua vÃ²ng láº·p nÃ y.`);
      // In ra ná»™i dung lá»—i náº¿u cÃ³, giÃºp debug WAF/Cloudflare
      if (res && res.body) {
        console.error(`Body lá»—i nháº­n Ä‘Æ°á»£c: ${res.body.substring(0, 200)}...`);
      }
      sleep(1); // Dá»«ng má»™t chÃºt
      return; // ThoÃ¡t khá»i ká»‹ch báº£n nÃ y ngay láº­p tá»©c, khÃ´ng Ä‘á»ƒ nÃ³ crash
    }

    // Chá»‰ khi trang chá»§ OK, chÃºng ta má»›i tiáº¿p tá»¥c
    const token = extractToken(res);
    if (!token) {
      console.error('KhÃ´ng thá»ƒ trÃ­ch xuáº¥t token tá»« trang chá»§. CÃ³ thá»ƒ cáº¥u trÃºc trang Ä‘Ã£ thay Ä‘á»•i.');
      return;
    }

    // CÃ¡c bÆ°á»›c tiáº¿p theo giá»¯ nguyÃªn, nhÆ°ng giá» chÃºng an toÃ n hÆ¡n
    const searchTerms = ['certificate', 'ipa library', 'tutorial', 'rules'];
    const term = searchTerms[Math.floor(Math.random() * searchTerms.length)];
    const searchRes = http.post(
      `${BASE_URL}/search/search`,
      { keywords: term, _xfToken: token },
      { tags: { name: 'Search' } }
    );
    check(searchRes, { 'TÃ¬m kiáº¿m thÃ nh cÃ´ng': (r) => r && r.status === 200 });
  });
  sleep(Math.random() * 5 + 5);
}

// --- HÃ€NH VI Cá»¦A THÃ€NH VIÃŠN (MEMBER) ---
// (HÃ m nÃ y cÅ©ng cáº§n Ä‘Æ°á»£c sá»­a tÆ°Æ¡ng tá»±, nhÆ°ng chÃºng ta hÃ£y táº­p trung vÃ o guestScenario trÆ°á»›c)
export function memberScenario() {
    // ... báº¡n cÃ³ thá»ƒ Ã¡p dá»¥ng logic kiá»ƒm tra tÆ°Æ¡ng tá»± cho hÃ m nÃ y ...
    // Äá»ƒ Ä‘Æ¡n giáº£n, táº¡m thá»i bá» qua hÃ m nÃ y Ä‘á»ƒ táº­p trung debug
    sleep(1);
}

// --- HÃ€M Há»– TRá»¢ ---
function extractToken(res) {
  // HÃ m nÃ y giá» an toÃ n hÆ¡n vÃ¬ nÃ³ chá»‰ Ä‘Æ°á»£c gá»i khi res há»£p lá»‡
  if (!res || !res.body) {
    return null;
  }
  const doc = html.parse(res.body);
  const tokenElement = doc.find('input[name="_xfToken"]');
  if (tokenElement.length > 0) {
    return tokenElement.first().attr('value');
  }
  const dataCsrf = doc.find('html').attr('data-csrf');
  if (dataCsrf) {
    return dataCsrf;
  }
  return null;
}
