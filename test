
import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { SharedArray } from 'k6/data';

// --- CẤU HÌNH BÀI TEST ---
export const options = {
  stages: [
    // Tăng tải từ từ lên 1000 VUs trong 5 phút để hệ thống có thời gian thích ứng
    { duration: '1s', target: 2000 },
    // Duy trì tải 1000 VUs trong 1 giờ (có thể đổi lại thành '900m' cho endurance test)
    { duration: '3h', target: 20000 },
    // Giảm tải từ từ trong 5 phút
    { duration: '5m', target: 0 },
  ],
  thresholds: {
    'http_req_duration': ['p(95)<1000'], // Tăng nhẹ ngưỡng lên 1s vì test phức tạp hơn
    'http_req_failed': ['rate<0.01'],    // Tỷ lệ lỗi dưới 1%
    'checks': ['rate>0.98'],             // Hơn 98% các check phải thành công
  },
};

// --- DỮ LIỆU TEST ---
// Sử dụng SharedArray để chỉ đọc dữ liệu một lần và chia sẻ giữa các VUs
const BASE_URL = 'https://certapple.com';

const mainPages = new SharedArray('main-pages', function () {
  return [
    '/',
    '/about',
    '/account/orders',
    '/blog',
    '/block-ota',
    '/cookies',
    '/faq',
    '/privacy-policy',
    '/support',
    '/terms-conditions',
  ];
});

const blogPosts = new SharedArray('blog-posts', function () {
  return [
    '/blog/cac-nguyen-tac-su-dung-thuong-hieu-cua-certapplecom',
    '/blog/cach-lay-chung-chi-apple-cho-iphone-ipad-mien-phi-tai-certapplecom',
    '/blog/chinh-sach-bao-mat-ung-dung-certapple',
    '/blog/chinh-sach-du-lieu-nguoi-dung-cua-certapple-api-services',
    '/blog/chuong-trinh-dai-ly-ky-quy',
    '/blog/chuong-trinh-tiep-thi-lien-ket',
    '/blog/dieu-khoan-dich-vu-api-cua-certapplecom',
    '/blog/gioi-thieu-ve-tinh-nang-bao-ve-thiet-bi-khi-bi-danh-cap-cho-iphone',
    '/blog/huong-dan-su-dung-esign-de-cai-ipa-tren-cac-thiet-bi-iphoneipad',
    '/blog/ios-16-developer-mode-bi-an-cach-bat-developer-mode-bi-an-tren-iphone',
  ];
});

// Gộp chung các tài nguyên tĩnh (CSS, JS, Images)
const assets = new SharedArray('assets', function () {
  return [
    // CSS
    '/assets/css/bootstrap-icons.css', '/assets/css/components.css', '/assets/css/critical.css', '/assets/css/custom.css?v=1.3.5', '/assets/css/progressive-loading.css', '/assets/css/style.css?v=1.3.5', '/assets/css/swiper.min.css', '/assets/css/toastr.min.css', '/assets/vendor/slick/slick-theme.min.css', '/assets/vendor/slick/slick.css',
    // JS
    '/assets/js/critical.js', '/assets/js/custom.js?v=1.3.5', '/assets/js/head.built.js', '/assets/js/jquery.lazyload.min.js', '/assets/js/jquery.min.js', '/assets/js/main.built.js', '/assets/js/moment.min.js', '/assets/js/performance-monitor.js', '/assets/js/progressive-content-loader.js', '/assets/js/swiper.min.js', '/assets/js/toastr.min.js', '/assets/vendor/slick/slick.min.js', '/assets/vendor/web-vitals/web-vitals.iife.js',
    // Images
    '/assets/image/logo/logo-cert.png', '/assets/image/banner/BANNED.png', '/assets/image/favicon/favicon.svg', '/assets/image/logo/logo.svg', 'https://h5m4.c19.e2-1.dev/image-video/banner/certappleogi.jpg', 'https://h5m4.c19.e2-1.dev/image-video/blog/24h.png',
  ];
});


// --- LOGIC CHÍNH CỦA VU ---
export default function () {
  // Phân bổ hành vi của người dùng ảo một cách ngẫu nhiên
  // 60% truy cập trang chính, 40% đọc blog
  const choice = Math.random();
  if (choice < 0.6) {
    browseMainPages();
  } else {
    readBlogPost();
  }

  // Mô phỏng người dùng dừng lại trước khi thực hiện hành động tiếp theo
  sleep(Math.random() * 3 + 1); // Dừng từ 1 đến 4 giây
}

// --- CÁC LUỒNG HÀNH VI (USER FLOWS) ---

function browseMainPages() {
  group('Flow: Browse Main Pages', function () {
    // 1. Chọn một trang chính ngẫu nhiên
    const pagePath = mainPages[Math.floor(Math.random() * mainPages.length)];
    const pageUrl = `${BASE_URL}${pagePath}`;

    // 2. Gửi request tới trang chính và kiểm tra
    const res = http.get(pageUrl, { tags: { name: 'MainPage' } });
    check(res, {
      'Main page status is 200': (r) => r.status === 200,
    });

    // 3. Tải song song một vài tài nguyên tĩnh (mô phỏng trình duyệt)
    loadRandomAssets(6); // Tải 6 tài nguyên ngẫu nhiên
  });
}

function readBlogPost() {
  group('Flow: Read Blog Post', function () {
    // 1. Chọn một bài blog ngẫu nhiên
    const blogPath = blogPosts[Math.floor(Math.random() * blogPosts.length)];
    const blogUrl = `${BASE_URL}${blogPath}`;

    // 2. Gửi request tới trang blog và kiểm tra
    const res = http.get(blogUrl, { tags: { name: 'BlogPost' } });
    check(res, {
      'Blog post status is 200': (r) => r.status === 200,
    });

    // 3. Tải song song một vài tài nguyên tĩnh
    loadRandomAssets(8); // Trang blog có thể có nhiều hình ảnh hơn, tải 8 tài nguyên
  });
}

function loadRandomAssets(count) {
  const requests = [];
  for (let i = 0; i < count; i++) {
    let assetUrl = assets[Math.floor(Math.random() * assets.length)];
    // Nếu URL không bắt đầu bằng http, thêm BASE_URL vào
    if (!assetUrl.startsWith('http')) {
      assetUrl = `${BASE_URL}${assetUrl}`;
    }
    requests.push(['GET', assetUrl, null, { tags: { name: 'Asset' } }]);
  }

  const responses = http.batch(requests);
  // Kiểm tra xem tất cả tài nguyên có được tải thành công không
  for (const res of responses) {
      check(res, {
          'Asset status is 200': (r) => r.status === 200,
      });
  }
}
