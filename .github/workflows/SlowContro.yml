# ‚úÖ File: .github/workflows/SlowContro.yml
# WORKFLOW ƒêI·ªÄU KHI·ªÇN (PHI√äN B·∫¢N T·ªêI ∆ØU H√ìA LOGIC)

name: üîÑ ƒêi·ªÅu Khi·ªÉn V√≤ng L·∫∑p Slow (T·ªëi ∆∞u)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL m·ª•c ti√™u cho c√°c l·∫ßn test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'S·ªë ph√∫t ch·ªù tr∆∞·ªõc khi kh·ªüi ƒë·ªông l·∫°i'
        required: true
        default: '6'
      child_runs:
        description: 'S·ªë action con (Slow.yml) ƒë∆∞·ª£c kh·ªüi ch·∫°y trong m·ªói chu k·ª≥'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: üîÑ V√≤ng L·∫∑p ƒêi·ªÅu Khi·ªÉn
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p v√¥ t·∫≠n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e
          
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ƒëi·ªÅu khi·ªÉn..."
          echo "URL m·ª•c ti√™u: $TARGET_URL"
          echo "S·ªë l·∫ßn ch·∫°y con m·ªói v√≤ng: $CHILD_RUNS"
          echo "Th·ªùi gian ch·ªù m·ªói v√≤ng: $WAIT_MINUTES ph√∫t ($WAIT_SECONDS gi√¢y)"

          # THAY ƒê·ªîI LOGIC 1: Kh·ªüi t·∫°o bi·∫øn ƒë·ªÉ l∆∞u ID b√™n ngo√†i v√≤ng l·∫∑p
          RUN_IDS_TO_CANCEL=""

          while true; do
            echo "-----------------------------------------------------"
            
            # THAY ƒê·ªîI LOGIC 2: D·ª´ng c√°c action t·ª´ v√≤ng l·∫∑p TR∆Ø·ªöC (n·∫øu c√≥)
            if [ -n "$RUN_IDS_TO_CANCEL" ]; then
              echo "üõë B·∫Øt ƒë·∫ßu d·ª´ng $CHILD_RUNS actions t·ª´ v√≤ng l·∫∑p tr∆∞·ªõc..."
              for id in $RUN_IDS_TO_CANCEL; do
                echo "-> ƒêang g·ª≠i l·ªánh h·ªßy cho run ID: $id"
                gh run cancel $id || echo "L·ªói khi h·ªßy run ID $id (c√≥ th·ªÉ n√≥ ƒë√£ k·∫øt th√∫c)."
              done
              echo "‚úÖ ƒê√£ g·ª≠i l·ªánh h·ªßy cho c√°c action c≈©."
            else
              echo "‚ÑπÔ∏è V√≤ng l·∫∑p ƒë·∫ßu ti√™n, kh√¥ng c√≥ action c≈© ƒë·ªÉ d·ª´ng."
            fi

            # B√¢y gi·ªù m·ªõi b·∫Øt ƒë·∫ßu ch·∫°y c√°c action M·ªöI
            echo "üöÄ B·∫Øt ƒë·∫ßu kh·ªüi ch·∫°y $CHILD_RUNS actions m·ªõi..."
            for i in $(seq 1 $CHILD_RUNS); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> ƒê√£ k√≠ch ho·∫°t l·∫ßn ch·∫°y th·ª© $i"
            done

            # Ch·ªù m·ªôt ch√∫t ƒë·ªÉ API ·ªïn ƒë·ªãnh
            sleep 15 
            
            # THAY ƒê·ªîI LOGIC 3: L·∫•y ID c·ªßa c√°c action M·ªöI v√† l∆∞u l·∫°i ƒë·ªÉ D·ª™NG ·ªû V√íNG L·∫∂P SAU
            echo "üîç L·∫•y ID c·ªßa $CHILD_RUNS l·∫ßn ch·∫°y m·ªõi ƒë·ªÉ chu·∫©n b·ªã cho v√≤ng l·∫∑p sau..."
            RUN_IDS_TO_CANCEL=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit $(($CHILD_RUNS * 2)) \
              --jq --argjson num_runs "$CHILD_RUNS" '[.[] | select(.status=="queued" or .status=="in_progress")] | sort_by(.createdAt) | reverse | .[0:$num_runs] | .[].databaseId' | tr '\n' ' ')

            if [ -z "$RUN_IDS_TO_CANCEL" ]; then
                echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID c·ªßa c√°c l·∫ßn ch·∫°y m·ªõi. S·∫Ω th·ª≠ l·∫°i ·ªü v√≤ng l·∫∑p sau."
            else
                echo "‚úÖ ƒê√£ l·∫•y ƒë∆∞·ª£c c√°c ID ƒë·ªÉ h·ªßy ·ªü v√≤ng l·∫∑p sau: $RUN_IDS_TO_CANCEL"
            fi

            # Ch·ªù ƒë·ª£i ƒë·ªÉ c√°c action m·ªõi ch·∫°y
            echo "‚è≥ Ch·ªù $WAIT_SECONDS gi√¢y ($WAIT_MINUTES ph√∫t)..."
            sleep $WAIT_SECONDS
            
            echo "üîÑ Ho√†n t·∫•t chu k·ª≥, chu·∫©n b·ªã cho v√≤ng l·∫∑p ti·∫øp theo..."
          done
