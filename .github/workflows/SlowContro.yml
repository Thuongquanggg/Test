# ✅ File: .github/workflows/SlowContro.yml
# WORKFLOW ĐIỀU KHIỂN VÒNG LẶP (ĐÃ SỬA LỖI)

name: 🔄 Điều Khiển Vòng Lặp Slow

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL mục tiêu cho các lần test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'Số phút chờ trước khi khởi động lại'
        required: true
        default: '1'

jobs:
  loop_controller:
    name: 🔄 Vòng Lặp Điều Khiển
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bắt đầu vòng lặp vô tận
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          # THAY ĐỔI 1: Chỉ truyền số phút vào, không tính toán ở đây
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
        run: |
          set -e # Dừng script nếu có lỗi
          
          # THAY ĐỔI 2: Thực hiện phép tính nhân bên trong script shell
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Bắt đầu vòng lặp điều khiển..."
          echo "URL mục tiêu: $TARGET_URL"
          echo "Thời gian chờ mỗi vòng: $WAIT_MINUTES phút ($WAIT_SECONDS giây)"

          while true; do
            echo "-----------------------------------------------------"
            echo "🚀 Bắt đầu khởi chạy 5 actions 'Kiểm Tra Web Slow'..."
            
            for i in $(seq 1 5); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> Đã kích hoạt lần chạy thứ $i"
            done

            sleep 15 
            
            echo "🔍 Lấy ID của 5 lần chạy vừa được kích hoạt..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit 10 \
              --jq '[.[] | select(.status=="queued" or .status=="in_progress")] | sort_by(.createdAt) | reverse | .[0:5] | .[].databaseId' | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "⚠️ Không tìm thấy ID của các lần chạy mới. Có thể API bị chậm. Sẽ thử lại ở vòng lặp sau."
            else
                echo "✅ Đã lấy được các ID: $RUN_IDS"
            fi

            # THAY ĐỔI 3: Sử dụng biến đã được tính toán
            echo "⏳ Chờ $WAIT_SECONDS giây ($WAIT_MINUTES phút)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "🛑 Ngừng 5 actions cũ..."
              for id in $RUN_IDS; do
                echo "-> Đang gửi lệnh hủy cho run ID: $id"
                gh run cancel $id || echo "Lỗi khi hủy run ID $id (có thể nó đã kết thúc)."
              done
              echo "✅ Đã gửi lệnh hủy."
            fi
            
            echo "🔄 Chuẩn bị cho vòng lặp tiếp theo..."
          done
