# ‚úÖ File: .github/workflows/SlowContro.yml
# WORKFLOW ƒêI·ªÄU KHI·ªÇN (PHI√äN B·∫¢N CU·ªêI C√ôNG - CH·ªêNG L·ªñI RACE CONDITION)

name: üîÑ ƒêi·ªÅu Khi·ªÉn V√≤ng L·∫∑p Slow (B·∫£n ·ªîn ƒê·ªãnh)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL m·ª•c ti√™u cho c√°c l·∫ßn test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'S·ªë ph√∫t ch·ªù tr∆∞·ªõc khi kh·ªüi ƒë·ªông l·∫°i'
        required: true
        default: '6'
      child_runs:
        description: 'S·ªë action con (Slow.yml) ƒë∆∞·ª£c kh·ªüi ch·∫°y trong m·ªói chu k·ª≥'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: üîÑ V√≤ng L·∫∑p ƒêi·ªÅu Khi·ªÉn
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p v√¥ t·∫≠n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e
          
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ƒëi·ªÅu khi·ªÉn..."
          echo "URL m·ª•c ti√™u: $TARGET_URL"
          echo "S·ªë l·∫ßn ch·∫°y con m·ªói v√≤ng: $CHILD_RUNS"
          echo "Th·ªùi gian ch·ªù m·ªói v√≤ng: $WAIT_MINUTES ph√∫t ($WAIT_SECONDS gi√¢y)"

          RUN_IDS_TO_CANCEL=""

          while true; do
            echo "-----------------------------------------------------"
            
            # D·ª´ng c√°c action t·ª´ v√≤ng l·∫∑p TR∆Ø·ªöC (n·∫øu c√≥)
            if [ -n "$RUN_IDS_TO_CANCEL" ]; then
              echo "üõë B·∫Øt ƒë·∫ßu d·ª´ng $CHILD_RUNS actions t·ª´ v√≤ng l·∫∑p tr∆∞·ªõc..."
              for id in $RUN_IDS_TO_CANCEL; do
                echo "-> ƒêang g·ª≠i l·ªánh h·ªßy cho run ID: $id"
                gh run cancel $id || echo "L·ªói khi h·ªßy run ID $id (c√≥ th·ªÉ n√≥ ƒë√£ k·∫øt th√∫c ho·∫∑c kh√¥ng t·ªìn t·∫°i)."
              done
              echo "‚úÖ ƒê√£ g·ª≠i l·ªánh h·ªßy cho c√°c action c≈©."
            else
              echo "‚ÑπÔ∏è V√≤ng l·∫∑p ƒë·∫ßu ti√™n, kh√¥ng c√≥ action c≈© ƒë·ªÉ d·ª´ng."
            fi

            # THAY ƒê·ªîI QUAN TR·ªåNG: L·∫•y ID tr·ª±c ti·∫øp thay v√¨ d√πng `gh run list`
            echo "üöÄ B·∫Øt ƒë·∫ßu kh·ªüi ch·∫°y $CHILD_RUNS actions m·ªõi v√† l·∫•y ID tr·ª±c ti·∫øp..."
            
            # Chu·∫©n b·ªã m·ªôt bi·∫øn ƒë·ªÉ l∆∞u c√°c ID m·ªõi
            NEW_RUN_IDS=""
            
            for i in $(seq 1 $CHILD_RUNS); do
              # Ch·∫°y workflow v√† ch·ª•p l·∫°i output (l√† URL c·ªßa run)
              RUN_URL=$(gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL")
              
              # Tr√≠ch xu·∫•t ID t·ª´ URL (l·∫•y ph·∫ßn cu·ªëi c√πng sau d·∫•u /)
              RUN_ID=$(echo "$RUN_URL" | awk -F'/' '{print $NF}')
              
              # Ki·ªÉm tra xem c√≥ l·∫•y ƒë∆∞·ª£c ID h·ª£p l·ªá kh√¥ng
              if [[ "$RUN_ID" =~ ^[0-9]+$ ]]; then
                echo "-> ƒê√£ k√≠ch ho·∫°t l·∫ßn ch·∫°y $i v·ªõi ID: $RUN_ID"
                # Th√™m ID v√†o danh s√°ch
                NEW_RUN_IDS="$NEW_RUN_IDS $RUN_ID"
              else
                echo "‚ö†Ô∏è L·ªói: Kh√¥ng th·ªÉ l·∫•y ƒë∆∞·ª£c Run ID cho l·∫ßn ch·∫°y th·ª© $i. Output: $RUN_URL"
              fi
            done
            
            # G√°n danh s√°ch ID m·ªõi v√†o bi·∫øn s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ h·ªßy ·ªü v√≤ng l·∫∑p sau
            RUN_IDS_TO_CANCEL=$(echo "$NEW_RUN_IDS" | xargs) # xargs ƒë·ªÉ x√≥a kho·∫£ng tr·∫Øng th·ª´a
            
            if [ -z "$RUN_IDS_TO_CANCEL" ]; then
                echo "‚ÄºÔ∏è L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ k√≠ch ho·∫°t v√† l·∫•y ID c·ªßa b·∫•t k·ª≥ action con n√†o. S·∫Ω th·ª≠ l·∫°i sau $WAIT_MINUTES ph√∫t."
            else
                echo "‚úÖ ƒê√£ l·∫•y ƒë∆∞·ª£c c√°c ID ƒë·ªÉ h·ªßy ·ªü v√≤ng l·∫∑p sau: $RUN_IDS_TO_CANCEL"
            fi

            # Ch·ªù ƒë·ª£i ƒë·ªÉ c√°c action m·ªõi ch·∫°y
            echo "‚è≥ Ch·ªù $WAIT_SECONDS gi√¢y ($WAIT_MINUTES ph√∫t)..."
            sleep $WAIT_SECONDS
            
            echo "üîÑ Ho√†n t·∫•t chu k·ª≥, chu·∫©n b·ªã cho v√≤ng l·∫∑p ti·∫øp theo..."
          done
