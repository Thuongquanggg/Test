
# âœ… File: .github/workflows/SlowContro.yml
# WORKFLOW ÄIá»€U KHIá»‚N VÃ’NG Láº¶P (CÃ“ THá»‚ TÃ™Y CHá»ˆNH Sá» LÆ¯á»¢á»¢NG)

name: ğŸ”„ Äiá»u Khiá»ƒn VÃ²ng Láº·p Slow

# ThÃªm concurrency Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ cÃ³ 1 controller cháº¡y táº¡i má»™t thá»i Ä‘iá»ƒm
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL má»¥c tiÃªu cho cÃ¡c láº§n test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'Sá»‘ phÃºt chá» trÆ°á»›c khi khá»Ÿi Ä‘á»™ng láº¡i'
        required: true
        default: '6'
      # ThÃªm input má»›i cho sá»‘ lÆ°á»£ng worker
      child_runs:
        description: 'Sá»‘ láº§n cháº¡y con (worker) Ä‘Æ°á»£c khá»Ÿi cháº¡y má»—i vÃ²ng láº·p'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: ğŸ”„ VÃ²ng Láº·p Äiá»u Khiá»ƒn
    runs-on: ubuntu-latest
    # ThÃªm timeout Ä‘á»ƒ trÃ¡nh cháº¡y vÃ´ háº¡n ngoÃ i Ã½ muá»‘n (tá»‘i Ä‘a 6 giá»)
    timeout-minutes: 350

    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Báº¯t Ä‘áº§u vÃ²ng láº·p
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e # Dá»«ng script náº¿u cÃ³ lá»—i

          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p Ä‘iá»u khiá»ƒn..."
          echo "URL má»¥c tiÃªu: $TARGET_URL"
          echo "Sá»‘ worker má»—i vÃ²ng: $CHILD_RUNS"
          echo "Thá»i gian chá» má»—i vÃ²ng: $WAIT_MINUTES phÃºt ($WAIT_SECONDS giÃ¢y)"

          while true; do
            echo "-----------------------------------------------------"
            echo "ğŸš€ Báº¯t Ä‘áº§u khá»Ÿi cháº¡y $CHILD_RUNS actions 'Kiá»ƒm Tra Web Slow'..."

            for i in $(seq 1 $CHILD_RUNS); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> ÄÃ£ kÃ­ch hoáº¡t láº§n cháº¡y thá»© $i"
            done

            sleep 15

            echo "ğŸ” Láº¥y ID cá»§a $CHILD_RUNS láº§n cháº¡y vá»«a Ä‘Æ°á»£c kÃ­ch hoáº¡t..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit $(($CHILD_RUNS + 5)) \
              --jq "[.[] | select(.status==\"queued\" or .status==\"in_progress\")] | sort_by(.createdAt) | reverse | .[0:$CHILD_RUNS] | .[].databaseId" | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y ID cá»§a cÃ¡c láº§n cháº¡y má»›i. CÃ³ thá»ƒ API bá»‹ cháº­m. Sáº½ thá»­ láº¡i á»Ÿ vÃ²ng láº·p sau."
            else
                echo "âœ… ÄÃ£ láº¥y Ä‘Æ°á»£c cÃ¡c ID: $RUN_IDS"
            fi

            echo "â³ Chá» $WAIT_SECONDS giÃ¢y ($WAIT_MINUTES phÃºt)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "ğŸ›‘ Ngá»«ng $CHILD_RUNS actions cÅ©..."
              for id in $RUN_IDS; do
                echo "-> Äang gá»­i lá»‡nh há»§y cho run ID: $id"
                gh run cancel $id || echo "Lá»—i khi há»§y run ID $id (cÃ³ thá»ƒ nÃ³ Ä‘Ã£ káº¿t thÃºc)."
              done
              echo "âœ… ÄÃ£ gá»­i lá»‡nh há»§y."
            fi

            # =================== PHáº¦N Dá»ŒN Dáº¸P ===================
            echo "ğŸ§¹ Dá»n dáº¹p táº¥t cáº£ cÃ¡c runs Ä‘Ã£ dá»«ng trong repository..."
            # Lá»‡nh nÃ y quÃ©t táº¥t cáº£ cÃ¡c workflow. Run nÃ o chÆ°a ká»‹p cáº­p nháº­t tráº¡ng thÃ¡i sáº½ Ä‘Æ°á»£c dá»n dáº¹p á»Ÿ vÃ²ng láº·p sau.
            DELETABLE_RUN_IDS=$(gh run list --limit 100 --json databaseId,status \
              --jq '[.[] | select(.status=="completed" or .status=="cancelled" or .status=="failure")] | .[].databaseId' | tr '\n' ' ')

            if [ -n "$DELETABLE_RUN_IDS" ]; then
              echo "ğŸ” TÃ¬m tháº¥y cÃ¡c runs cÃ³ thá»ƒ xÃ³a: $DELETABLE_RUN_IDS"
              for id in $DELETABLE_RUN_IDS; do
                echo "-> Äang xÃ³a run ID: $id"
                gh run delete $id --yes || echo "Lá»—i khi xÃ³a run ID $id."
              done
              echo "âœ… ÄÃ£ dá»n dáº¹p xong."
            else
              echo "ğŸ‘ KhÃ´ng cÃ³ run nÃ o cáº§n dá»n dáº¹p."
            fi
            # ==========================================================

            echo "ğŸ”„ Chuáº©n bá»‹ cho vÃ²ng láº·p tiáº¿p theo..."
          done
