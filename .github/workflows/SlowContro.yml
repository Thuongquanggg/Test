
# ‚úÖ File: .github/workflows/SlowContro.yml
# WORKFLOW ƒêI·ªÄU KHI·ªÇN V√íNG L·∫∂P (C√ì TH·ªÇ T√ôY CH·ªàNH S·ªê L∆Ø·ª¢·ª¢NG)

name: üîÑ ƒêi·ªÅu Khi·ªÉn V√≤ng L·∫∑p Slow

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL m·ª•c ti√™u cho c√°c l·∫ßn test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'S·ªë ph√∫t ch·ªù tr∆∞·ªõc khi kh·ªüi ƒë·ªông l·∫°i'
        required: true
        default: '6'
      child_runs:
        description: 'S·ªë l·∫ßn ch·∫°y con (worker) ƒë∆∞·ª£c kh·ªüi ch·∫°y m·ªói v√≤ng l·∫∑p'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: üîÑ V√≤ng L·∫∑p ƒêi·ªÅu Khi·ªÉn
    runs-on: ubuntu-latest
    timeout-minutes: 350
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e # D·ª´ng script n·∫øu c√≥ l·ªói

          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ƒëi·ªÅu khi·ªÉn..."
          echo "URL m·ª•c ti√™u: $TARGET_URL"
          echo "S·ªë worker m·ªói v√≤ng: $CHILD_RUNS"
          echo "Th·ªùi gian ch·ªù m·ªói v√≤ng: $WAIT_MINUTES ph√∫t ($WAIT_SECONDS gi√¢y)"

          while true; do
            echo "-----------------------------------------------------"
            echo "üöÄ B·∫Øt ƒë·∫ßu kh·ªüi ch·∫°y $CHILD_RUNS actions 'Ki·ªÉm Tra Web Slow'..."

            for i in $(seq 1 $CHILD_RUNS); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> ƒê√£ k√≠ch ho·∫°t l·∫ßn ch·∫°y th·ª© $i"
            done

            sleep 15

            echo "üîç L·∫•y ID c·ªßa $CHILD_RUNS l·∫ßn ch·∫°y v·ª´a ƒë∆∞·ª£c k√≠ch ho·∫°t..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit $(($CHILD_RUNS + 5)) \
              --jq "[.[] | select(.status==\"queued\" or .status==\"in_progress\")] | sort_by(.createdAt) | reverse | .[0:$CHILD_RUNS] | .[].databaseId" | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID c·ªßa c√°c l·∫ßn ch·∫°y m·ªõi. C√≥ th·ªÉ API b·ªã ch·∫≠m. S·∫Ω th·ª≠ l·∫°i ·ªü v√≤ng l·∫∑p sau."
            else
                echo "‚úÖ ƒê√£ l·∫•y ƒë∆∞·ª£c c√°c ID: $RUN_IDS"
            fi

            echo "‚è≥ Ch·ªù $WAIT_SECONDS gi√¢y ($WAIT_MINUTES ph√∫t)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "üõë Ng·ª´ng $CHILD_RUNS actions c≈©..."
              for id in $RUN_IDS; do
                echo "-> ƒêang g·ª≠i l·ªánh h·ªßy cho run ID: $id"
                gh run cancel $id || echo "L·ªói khi h·ªßy run ID $id (c√≥ th·ªÉ n√≥ ƒë√£ k·∫øt th√∫c)."
              done
              echo "‚úÖ ƒê√£ g·ª≠i l·ªánh h·ªßy."
            fi

            # =================== PH·∫¶N D·ªåN D·∫∏P ===================
            echo "üßπ D·ªçn d·∫πp t·∫•t c·∫£ c√°c runs ƒë√£ d·ª´ng trong repository..."
            DELETABLE_RUN_IDS=$(gh run list --limit 100 --json databaseId,status \
              --jq '[.[] | select(.status=="completed" or .status=="cancelled" or .status=="failure")] | .[].databaseId' | tr '\n' ' ')

            if [ -n "$DELETABLE_RUN_IDS" ]; then
              echo "üîé T√¨m th·∫•y c√°c runs c√≥ th·ªÉ x√≥a: $DELETABLE_RUN_IDS"
              for id in $DELETABLE_RUN_IDS; do
                echo "-> ƒêang x√≥a run ID: $id"
                # Tinh ch·ªânh ƒë·ªÉ ·∫©n l·ªói "Broken pipe" (v√¥ h·∫°i)
                (yes 2>/dev/null) | gh run delete $id || echo "L·ªói khi x√≥a run ID $id."
              done
              echo "‚úÖ ƒê√£ d·ªçn d·∫πp xong."
            else
              echo "üëç Kh√¥ng c√≥ run n√†o c·∫ßn d·ªçn d·∫πp."
            fi
            # ==========================================================

            echo "üîÑ Chu·∫©n b·ªã cho v√≤ng l·∫∑p ti·∫øp theo..."
          done
