# âœ… File: .github/workflows/SlowContro.yml
# WORKFLOW ÄIá»€U KHIá»‚N VÃ’NG Láº¶P (ÄÃƒ Sá»¬A Lá»–I)

name: ğŸ”„ Äiá»u Khiá»ƒn VÃ²ng Láº·p Slow

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL má»¥c tiÃªu cho cÃ¡c láº§n test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'Sá»‘ phÃºt chá» trÆ°á»›c khi khá»Ÿi Ä‘á»™ng láº¡i'
        required: true
        default: '1'

jobs:
  loop_controller:
    name: ğŸ”„ VÃ²ng Láº·p Äiá»u Khiá»ƒn
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Báº¯t Ä‘áº§u vÃ²ng láº·p vÃ´ táº­n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          # THAY Äá»”I 1: Chá»‰ truyá»n sá»‘ phÃºt vÃ o, khÃ´ng tÃ­nh toÃ¡n á»Ÿ Ä‘Ã¢y
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
        run: |
          set -e # Dá»«ng script náº¿u cÃ³ lá»—i
          
          # THAY Äá»”I 2: Thá»±c hiá»‡n phÃ©p tÃ­nh nhÃ¢n bÃªn trong script shell
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p Ä‘iá»u khiá»ƒn..."
          echo "URL má»¥c tiÃªu: $TARGET_URL"
          echo "Thá»i gian chá» má»—i vÃ²ng: $WAIT_MINUTES phÃºt ($WAIT_SECONDS giÃ¢y)"

          while true; do
            echo "-----------------------------------------------------"
            echo "ğŸš€ Báº¯t Ä‘áº§u khá»Ÿi cháº¡y 5 actions 'Kiá»ƒm Tra Web Slow'..."
            
            for i in $(seq 1 5); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> ÄÃ£ kÃ­ch hoáº¡t láº§n cháº¡y thá»© $i"
            done

            sleep 15 
            
            echo "ğŸ” Láº¥y ID cá»§a 5 láº§n cháº¡y vá»«a Ä‘Æ°á»£c kÃ­ch hoáº¡t..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit 10 \
              --jq '[.[] | select(.status=="queued" or .status=="in_progress")] | sort_by(.createdAt) | reverse | .[0:5] | .[].databaseId' | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y ID cá»§a cÃ¡c láº§n cháº¡y má»›i. CÃ³ thá»ƒ API bá»‹ cháº­m. Sáº½ thá»­ láº¡i á»Ÿ vÃ²ng láº·p sau."
            else
                echo "âœ… ÄÃ£ láº¥y Ä‘Æ°á»£c cÃ¡c ID: $RUN_IDS"
            fi

            # THAY Äá»”I 3: Sá»­ dá»¥ng biáº¿n Ä‘Ã£ Ä‘Æ°á»£c tÃ­nh toÃ¡n
            echo "â³ Chá» $WAIT_SECONDS giÃ¢y ($WAIT_MINUTES phÃºt)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "ğŸ›‘ Ngá»«ng 5 actions cÅ©..."
              for id in $RUN_IDS; do
                echo "-> Äang gá»­i lá»‡nh há»§y cho run ID: $id"
                gh run cancel $id || echo "Lá»—i khi há»§y run ID $id (cÃ³ thá»ƒ nÃ³ Ä‘Ã£ káº¿t thÃºc)."
              done
              echo "âœ… ÄÃ£ gá»­i lá»‡nh há»§y."
            fi
            
            echo "ğŸ”„ Chuáº©n bá»‹ cho vÃ²ng láº·p tiáº¿p theo..."
          done
