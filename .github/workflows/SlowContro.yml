Chào bạn, yêu cầu của bạn rất thú vị và hoàn toàn có thể thực hiện được bằng cách sử dụng một “workflow điều khiển” (controller workflow).

Workflow này sẽ hoạt động như một người quản lý:

	1.	Nó sẽ khởi chạy 5 lần workflow Slow.yml của bạn.
	2.	Lấy ID của 5 lần chạy đó.
	3.	Chờ 6 phút.
	4.	Gửi lệnh hủy (cancel) 5 lần chạy đó.
	5.	Lặp lại từ đầu.

Dưới đây là giải pháp hoàn chỉnh. Bạn cần tạo một file workflow mới và giữ nguyên file Slow.yml của mình.

Bước 1: Giữ nguyên file Slow.yml của bạn

File .github/workflows/Slow.yml của bạn đã chuẩn, không cần sửa gì cả. Nó được thiết kế để nhận lệnh từ bên ngoài, rất phù hợp cho kịch bản này.

# 🅾️ File: .github/workflows/Slow.yml
# KHÔNG CẦN SỬA FILE NÀY

name: 🚀 Kiểm Tra Web Slow
run-name: 🚀 ${{ github.event.inputs.target_url }} 

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL để chạy k6 test (ví dụ: https://google.com)'
        required: true
        default: 'https://certapple.com'

jobs:
  k6_load_test:
    name: Chạy k6 Load Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Chạy k6 local test
        uses: k6io/k6-action@v0.3.1
        with:
          filename: Slow # Tên file script k6 của bạn, ví dụ: script.js
        env:
          TARGET_URL: ${{ github.event.inputs.target_url }}

Lưu ý: filename: Slow trong file trên có nghĩa là bạn có một file k6 script tên là Slow (hoặc Slow.js). Hãy đảm bảo tên này đúng với file script của bạn.

Bước 2: Tạo file Workflow Điều Khiển mới

Bây giờ, hãy tạo một file mới có tên là controller.yml (hoặc tên nào bạn thích) trong cùng thư mục .github/workflows/.

File: .github/workflows/SlowContro.yml

Chào bạn, bạn đã phát hiện ra một lỗi rất chính xác!

Lý do bạn gặp lỗi này là vì cú pháp biểu thức ${{ ... }} của GitHub Actions không hỗ trợ các phép toán số học trực tiếp như phép nhân (*). Đây là một hạn chế của trình phân tích cú pháp YAML của Actions.

Giải pháp

Giải pháp rất đơn giản: chúng ta sẽ không tính toán trong khối env, mà sẽ thực hiện phép tính đó ngay bên trong script run.

	1.	Trong khối env, chúng ta sẽ chỉ truyền vào số phút (wait_minutes).
	2.	Trong script run, chúng ta sẽ tạo một biến mới (WAIT_SECONDS) bằng cách nhân số phút với 60 bằng cú pháp của shell.

Dưới đây là file SlowContro.yml đã được sửa lại chính xác. Bạn chỉ cần sao chép và dán toàn bộ nội dung này để thay thế file cũ.

File SlowContro.yml đã sửa lỗi

# ✅ File: .github/workflows/SlowContro.yml
# WORKFLOW ĐIỀU KHIỂN VÒNG LẶP (ĐÃ SỬA LỖI)

name: 🔄 Điều Khiển Vòng Lặp Slow

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL mục tiêu cho các lần test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'Số phút chờ trước khi khởi động lại'
        required: true
        default: '6'

jobs:
  loop_controller:
    name: 🔄 Vòng Lặp Điều Khiển
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bắt đầu vòng lặp vô tận
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          # THAY ĐỔI 1: Chỉ truyền số phút vào, không tính toán ở đây
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
        run: |
          set -e # Dừng script nếu có lỗi
          
          # THAY ĐỔI 2: Thực hiện phép tính nhân bên trong script shell
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Bắt đầu vòng lặp điều khiển..."
          echo "URL mục tiêu: $TARGET_URL"
          echo "Thời gian chờ mỗi vòng: $WAIT_MINUTES phút ($WAIT_SECONDS giây)"

          while true; do
            echo "-----------------------------------------------------"
            echo "🚀 Bắt đầu khởi chạy 5 actions 'Kiểm Tra Web Slow'..."
            
            for i in $(seq 1 5); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> Đã kích hoạt lần chạy thứ $i"
            done

            sleep 15 
            
            echo "🔍 Lấy ID của 5 lần chạy vừa được kích hoạt..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit 10 \
              --jq '[.[] | select(.status=="queued" or .status=="in_progress")] | sort_by(.createdAt) | reverse | .[0:5] | .[].databaseId' | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "⚠️ Không tìm thấy ID của các lần chạy mới. Có thể API bị chậm. Sẽ thử lại ở vòng lặp sau."
            else
                echo "✅ Đã lấy được các ID: $RUN_IDS"
            fi

            # THAY ĐỔI 3: Sử dụng biến đã được tính toán
            echo "⏳ Chờ $WAIT_SECONDS giây ($WAIT_MINUTES phút)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "🛑 Ngừng 5 actions cũ..."
              for id in $RUN_IDS; do
                echo "-> Đang gửi lệnh hủy cho run ID: $id"
                gh run cancel $id || echo "Lỗi khi hủy run ID $id (có thể nó đã kết thúc)."
              done
              echo "✅ Đã gửi lệnh hủy."
            fi
            
            echo "🔄 Chuẩn bị cho vòng lặp tiếp theo..."
          done
