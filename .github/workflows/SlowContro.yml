
# ✅ File: .github/workflows/SlowContro.yml
# WORKFLOW ĐIỀU KHIỂN VÒNG LẶP (CÓ THỂ TÙY CHỈNH SỐ LƯỢỢNG)

name: 🔄 Điều Khiển Vòng Lặp Slow

# Thêm concurrency để đảm bảo chỉ có 1 controller chạy tại một thời điểm
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL mục tiêu cho các lần test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'Số phút chờ trước khi khởi động lại'
        required: true
        default: '6'
      # Thêm input mới cho số lượng worker
      child_runs:
        description: 'Số lần chạy con (worker) được khởi chạy mỗi vòng lặp'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: 🔄 Vòng Lặp Điều Khiển
    runs-on: ubuntu-latest
    # Thêm timeout để tránh chạy vô hạn ngoài ý muốn (tối đa 6 giờ)
    timeout-minutes: 350

    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Bắt đầu vòng lặp
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e # Dừng script nếu có lỗi

          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Bắt đầu vòng lặp điều khiển..."
          echo "URL mục tiêu: $TARGET_URL"
          echo "Số worker mỗi vòng: $CHILD_RUNS"
          echo "Thời gian chờ mỗi vòng: $WAIT_MINUTES phút ($WAIT_SECONDS giây)"

          while true; do
            echo "-----------------------------------------------------"
            echo "🚀 Bắt đầu khởi chạy $CHILD_RUNS actions 'Kiểm Tra Web Slow'..."

            for i in $(seq 1 $CHILD_RUNS); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> Đã kích hoạt lần chạy thứ $i"
            done

            sleep 15

            echo "🔍 Lấy ID của $CHILD_RUNS lần chạy vừa được kích hoạt..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit $(($CHILD_RUNS + 5)) \
              --jq "[.[] | select(.status==\"queued\" or .status==\"in_progress\")] | sort_by(.createdAt) | reverse | .[0:$CHILD_RUNS] | .[].databaseId" | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "⚠️ Không tìm thấy ID của các lần chạy mới. Có thể API bị chậm. Sẽ thử lại ở vòng lặp sau."
            else
                echo "✅ Đã lấy được các ID: $RUN_IDS"
            fi

            echo "⏳ Chờ $WAIT_SECONDS giây ($WAIT_MINUTES phút)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "🛑 Ngừng $CHILD_RUNS actions cũ..."
              for id in $RUN_IDS; do
                echo "-> Đang gửi lệnh hủy cho run ID: $id"
                gh run cancel $id || echo "Lỗi khi hủy run ID $id (có thể nó đã kết thúc)."
              done
              echo "✅ Đã gửi lệnh hủy."
            fi

            # =================== PHẦN DỌN DẸP ===================
            echo "🧹 Dọn dẹp tất cả các runs đã dừng trong repository..."
            # Lệnh này quét tất cả các workflow. Run nào chưa kịp cập nhật trạng thái sẽ được dọn dẹp ở vòng lặp sau.
            DELETABLE_RUN_IDS=$(gh run list --limit 100 --json databaseId,status \
              --jq '[.[] | select(.status=="completed" or .status=="cancelled" or .status=="failure")] | .[].databaseId' | tr '\n' ' ')

            if [ -n "$DELETABLE_RUN_IDS" ]; then
              echo "🔎 Tìm thấy các runs có thể xóa: $DELETABLE_RUN_IDS"
              for id in $DELETABLE_RUN_IDS; do
                echo "-> Đang xóa run ID: $id"
                gh run delete $id --yes || echo "Lỗi khi xóa run ID $id."
              done
              echo "✅ Đã dọn dẹp xong."
            else
              echo "👍 Không có run nào cần dọn dẹp."
            fi
            # ==========================================================

            echo "🔄 Chuẩn bị cho vòng lặp tiếp theo..."
          done
