ChÃ o báº¡n, yÃªu cáº§u cá»§a báº¡n ráº¥t thÃº vá»‹ vÃ  hoÃ n toÃ n cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c báº±ng cÃ¡ch sá»­ dá»¥ng má»™t â€œworkflow Ä‘iá»u khiá»ƒnâ€ (controller workflow).

Workflow nÃ y sáº½ hoáº¡t Ä‘á»™ng nhÆ° má»™t ngÆ°á»i quáº£n lÃ½:

	1.	NÃ³ sáº½ khá»Ÿi cháº¡y 5 láº§n workflow Slow.yml cá»§a báº¡n.
	2.	Láº¥y ID cá»§a 5 láº§n cháº¡y Ä‘Ã³.
	3.	Chá» 6 phÃºt.
	4.	Gá»­i lá»‡nh há»§y (cancel) 5 láº§n cháº¡y Ä‘Ã³.
	5.	Láº·p láº¡i tá»« Ä‘áº§u.

DÆ°á»›i Ä‘Ã¢y lÃ  giáº£i phÃ¡p hoÃ n chá»‰nh. Báº¡n cáº§n táº¡o má»™t file workflow má»›i vÃ  giá»¯ nguyÃªn file Slow.yml cá»§a mÃ¬nh.

BÆ°á»›c 1: Giá»¯ nguyÃªn file Slow.yml cá»§a báº¡n

File .github/workflows/Slow.yml cá»§a báº¡n Ä‘Ã£ chuáº©n, khÃ´ng cáº§n sá»­a gÃ¬ cáº£. NÃ³ Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ nháº­n lá»‡nh tá»« bÃªn ngoÃ i, ráº¥t phÃ¹ há»£p cho ká»‹ch báº£n nÃ y.

# ğŸ…¾ï¸ File: .github/workflows/Slow.yml
# KHÃ”NG Cáº¦N Sá»¬A FILE NÃ€Y

name: ğŸš€ Kiá»ƒm Tra Web Slow
run-name: ğŸš€ ${{ github.event.inputs.target_url }} 

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL Ä‘á»ƒ cháº¡y k6 test (vÃ­ dá»¥: https://google.com)'
        required: true
        default: 'https://certapple.com'

jobs:
  k6_load_test:
    name: Cháº¡y k6 Load Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cháº¡y k6 local test
        uses: k6io/k6-action@v0.3.1
        with:
          filename: Slow # TÃªn file script k6 cá»§a báº¡n, vÃ­ dá»¥: script.js
        env:
          TARGET_URL: ${{ github.event.inputs.target_url }}

LÆ°u Ã½: filename: Slow trong file trÃªn cÃ³ nghÄ©a lÃ  báº¡n cÃ³ má»™t file k6 script tÃªn lÃ  Slow (hoáº·c Slow.js). HÃ£y Ä‘áº£m báº£o tÃªn nÃ y Ä‘Ãºng vá»›i file script cá»§a báº¡n.

BÆ°á»›c 2: Táº¡o file Workflow Äiá»u Khiá»ƒn má»›i

BÃ¢y giá», hÃ£y táº¡o má»™t file má»›i cÃ³ tÃªn lÃ  controller.yml (hoáº·c tÃªn nÃ o báº¡n thÃ­ch) trong cÃ¹ng thÆ° má»¥c .github/workflows/.

File: .github/workflows/SlowContro.yml

ChÃ o báº¡n, báº¡n Ä‘Ã£ phÃ¡t hiá»‡n ra má»™t lá»—i ráº¥t chÃ­nh xÃ¡c!

LÃ½ do báº¡n gáº·p lá»—i nÃ y lÃ  vÃ¬ cÃº phÃ¡p biá»ƒu thá»©c ${{ ... }} cá»§a GitHub Actions khÃ´ng há»— trá»£ cÃ¡c phÃ©p toÃ¡n sá»‘ há»c trá»±c tiáº¿p nhÆ° phÃ©p nhÃ¢n (*). ÄÃ¢y lÃ  má»™t háº¡n cháº¿ cá»§a trÃ¬nh phÃ¢n tÃ­ch cÃº phÃ¡p YAML cá»§a Actions.

Giáº£i phÃ¡p

Giáº£i phÃ¡p ráº¥t Ä‘Æ¡n giáº£n: chÃºng ta sáº½ khÃ´ng tÃ­nh toÃ¡n trong khá»‘i env, mÃ  sáº½ thá»±c hiá»‡n phÃ©p tÃ­nh Ä‘Ã³ ngay bÃªn trong script run.

	1.	Trong khá»‘i env, chÃºng ta sáº½ chá»‰ truyá»n vÃ o sá»‘ phÃºt (wait_minutes).
	2.	Trong script run, chÃºng ta sáº½ táº¡o má»™t biáº¿n má»›i (WAIT_SECONDS) báº±ng cÃ¡ch nhÃ¢n sá»‘ phÃºt vá»›i 60 báº±ng cÃº phÃ¡p cá»§a shell.

DÆ°á»›i Ä‘Ã¢y lÃ  file SlowContro.yml Ä‘Ã£ Ä‘Æ°á»£c sá»­a láº¡i chÃ­nh xÃ¡c. Báº¡n chá»‰ cáº§n sao chÃ©p vÃ  dÃ¡n toÃ n bá»™ ná»™i dung nÃ y Ä‘á»ƒ thay tháº¿ file cÅ©.

File SlowContro.yml Ä‘Ã£ sá»­a lá»—i

# âœ… File: .github/workflows/SlowContro.yml
# WORKFLOW ÄIá»€U KHIá»‚N VÃ’NG Láº¶P (ÄÃƒ Sá»¬A Lá»–I)

name: ğŸ”„ Äiá»u Khiá»ƒn VÃ²ng Láº·p Slow

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL má»¥c tiÃªu cho cÃ¡c láº§n test'
        required: true
        default: 'https://certapple.com'
      wait_minutes:
        description: 'Sá»‘ phÃºt chá» trÆ°á»›c khi khá»Ÿi Ä‘á»™ng láº¡i'
        required: true
        default: '6'

jobs:
  loop_controller:
    name: ğŸ”„ VÃ²ng Láº·p Äiá»u Khiá»ƒn
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Báº¯t Ä‘áº§u vÃ²ng láº·p vÃ´ táº­n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL: ${{ github.event.inputs.target_url }}
          # THAY Äá»”I 1: Chá»‰ truyá»n sá»‘ phÃºt vÃ o, khÃ´ng tÃ­nh toÃ¡n á»Ÿ Ä‘Ã¢y
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
        run: |
          set -e # Dá»«ng script náº¿u cÃ³ lá»—i
          
          # THAY Äá»”I 2: Thá»±c hiá»‡n phÃ©p tÃ­nh nhÃ¢n bÃªn trong script shell
          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p Ä‘iá»u khiá»ƒn..."
          echo "URL má»¥c tiÃªu: $TARGET_URL"
          echo "Thá»i gian chá» má»—i vÃ²ng: $WAIT_MINUTES phÃºt ($WAIT_SECONDS giÃ¢y)"

          while true; do
            echo "-----------------------------------------------------"
            echo "ğŸš€ Báº¯t Ä‘áº§u khá»Ÿi cháº¡y 5 actions 'Kiá»ƒm Tra Web Slow'..."
            
            for i in $(seq 1 5); do
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$TARGET_URL"
              echo "-> ÄÃ£ kÃ­ch hoáº¡t láº§n cháº¡y thá»© $i"
            done

            sleep 15 
            
            echo "ğŸ” Láº¥y ID cá»§a 5 láº§n cháº¡y vá»«a Ä‘Æ°á»£c kÃ­ch hoáº¡t..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit 10 \
              --jq '[.[] | select(.status=="queued" or .status=="in_progress")] | sort_by(.createdAt) | reverse | .[0:5] | .[].databaseId' | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y ID cá»§a cÃ¡c láº§n cháº¡y má»›i. CÃ³ thá»ƒ API bá»‹ cháº­m. Sáº½ thá»­ láº¡i á»Ÿ vÃ²ng láº·p sau."
            else
                echo "âœ… ÄÃ£ láº¥y Ä‘Æ°á»£c cÃ¡c ID: $RUN_IDS"
            fi

            # THAY Äá»”I 3: Sá»­ dá»¥ng biáº¿n Ä‘Ã£ Ä‘Æ°á»£c tÃ­nh toÃ¡n
            echo "â³ Chá» $WAIT_SECONDS giÃ¢y ($WAIT_MINUTES phÃºt)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "ğŸ›‘ Ngá»«ng 5 actions cÅ©..."
              for id in $RUN_IDS; do
                echo "-> Äang gá»­i lá»‡nh há»§y cho run ID: $id"
                gh run cancel $id || echo "Lá»—i khi há»§y run ID $id (cÃ³ thá»ƒ nÃ³ Ä‘Ã£ káº¿t thÃºc)."
              done
              echo "âœ… ÄÃ£ gá»­i lá»‡nh há»§y."
            fi
            
            echo "ğŸ”„ Chuáº©n bá»‹ cho vÃ²ng láº·p tiáº¿p theo..."
          done
