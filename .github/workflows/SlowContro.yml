# âœ… File: .github/workflows/SlowContro.yml
# WORKFLOW ÄIá»€U KHIá»‚N VÃ’NG Láº¶P (CÃ“ THá»‚ TÃ™Y CHá»ˆNH Sá» LÆ¯á»¢á»¢NG)

name: ğŸ”„ Äiá»u Khiá»ƒn VÃ²ng Láº·p Slow

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      target_url_1:
        description: 'URL má»¥c tiÃªu chÃ­nh (báº¯t buá»™c)'
        required: true
        default: 'https://certapple.com'
      # THAY Äá»”I 1: URL 2 lÃ  tÃ¹y chá»n
      target_url_2:
        description: 'URL má»¥c tiÃªu thá»© hai (tÃ¹y chá»n, bá» trá»‘ng Ä‘á»ƒ chá»‰ dÃ¹ng URL 1)'
        required: false
        default: ''
      wait_minutes:
        description: 'Sá»‘ phÃºt chá» trÆ°á»›c khi khá»Ÿi Ä‘á»™ng láº¡i'
        required: true
        default: '6'
      child_runs:
        description: 'Sá»‘ láº§n cháº¡y con (worker) Ä‘Æ°á»£c khá»Ÿi cháº¡y má»—i vÃ²ng láº·p'
        required: true
        default: '5'

jobs:
  loop_controller:
    name: ğŸ”„ VÃ²ng Láº·p Äiá»u Khiá»ƒn
    runs-on: ubuntu-latest
    timeout-minutes: 350
    permissions:
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Báº¯t Ä‘áº§u vÃ²ng láº·p
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_URL_1: ${{ github.event.inputs.target_url_1 }}
          TARGET_URL_2: ${{ github.event.inputs.target_url_2 }}
          WAIT_MINUTES: ${{ github.event.inputs.wait_minutes }}
          CHILD_RUNS: ${{ github.event.inputs.child_runs }}
        run: |
          set -e # Dá»«ng script náº¿u cÃ³ lá»—i

          WAIT_SECONDS=$(($WAIT_MINUTES * 60))

          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p Ä‘iá»u khiá»ƒn..."
          echo "URL 1 (chÃ­nh): $TARGET_URL_1"
          if [ -n "$TARGET_URL_2" ]; then
            echo "URL 2 (phá»¥): $TARGET_URL_2"
          else
            echo "URL 2 khÃ´ng Ä‘Æ°á»£c cung cáº¥p. Táº¥t cáº£ runs sáº½ dÃ¹ng URL 1."
          fi
          echo "Sá»‘ worker má»—i vÃ²ng: $CHILD_RUNS"
          echo "Thá»i gian chá» má»—i vÃ²ng: $WAIT_MINUTES phÃºt ($WAIT_SECONDS giÃ¢y)"

          while true; do
            echo "-----------------------------------------------------"
            echo "ğŸš€ Báº¯t Ä‘áº§u khá»Ÿi cháº¡y $CHILD_RUNS actions 'Kiá»ƒm Tra Web Slow'..."

            # THAY Äá»”I 2: Logic láº·p linh hoáº¡t
            for i in $(seq 1 $CHILD_RUNS); do
              # Máº·c Ä‘á»‹nh dÃ¹ng URL 1
              CURRENT_URL="$TARGET_URL_1"
              
              # Náº¿u URL 2 tá»“n táº¡i VÃ€ Ä‘Ã¢y lÃ  láº§n cháº¡y cháºµn, thÃ¬ má»›i dÃ¹ng URL 2
              if [ -n "$TARGET_URL_2" ] && (( i % 2 == 0 )); then
                CURRENT_URL="$TARGET_URL_2"
              fi
              
              echo "-> KÃ­ch hoáº¡t láº§n cháº¡y $i vá»›i URL: $CURRENT_URL"
              gh workflow run Slow.yml --ref ${{ github.ref }} -f target_url="$CURRENT_URL"
            done

            sleep 15

            echo "ğŸ” Láº¥y ID cá»§a $CHILD_RUNS láº§n cháº¡y vá»«a Ä‘Æ°á»£c kÃ­ch hoáº¡t..."
            RUN_IDS=$(gh run list --workflow=Slow.yml --json databaseId,status,createdAt --limit $(($CHILD_RUNS + 5)) \
              --jq "[.[] | select(.status==\"queued\" or .status==\"in_progress\")] | sort_by(.createdAt) | reverse | .[0:$CHILD_RUNS] | .[].databaseId" | tr '\n' ' ')

            if [ -z "$RUN_IDS" ]; then
                echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y ID cá»§a cÃ¡c láº§n cháº¡y má»›i. CÃ³ thá»ƒ API bá»‹ cháº­m. Sáº½ thá»­ láº¡i á»Ÿ vÃ²ng láº·p sau."
            else
                echo "âœ… ÄÃ£ láº¥y Ä‘Æ°á»£c cÃ¡c ID: $RUN_IDS"
            fi

            echo "â³ Chá» $WAIT_SECONDS giÃ¢y ($WAIT_MINUTES phÃºt)..."
            sleep $WAIT_SECONDS

            if [ -n "$RUN_IDS" ]; then
              echo "ğŸ›‘ Ngá»«ng $CHILD_RUNS actions cÅ©..."
              for id in $RUN_IDS; do
                echo "-> Äang gá»­i lá»‡nh há»§y cho run ID: $id"
                gh run cancel $id || echo "Lá»—i khi há»§y run ID $id (cÃ³ thá»ƒ nÃ³ Ä‘Ã£ káº¿t thÃºc)."
              done
              echo "âœ… ÄÃ£ gá»­i lá»‡nh há»§y."
            fi

            echo "ğŸ§¹ Dá»n dáº¹p táº¥t cáº£ cÃ¡c runs Ä‘Ã£ dá»«ng trong repository..."
            DELETABLE_RUN_IDS=$(gh run list --limit 100 --json databaseId,status \
              --jq '[.[] | select(.status=="completed" or .status=="cancelled" or .status=="failure")] | .[].databaseId' | tr '\n' ' ')

            if [ -n "$DELETABLE_RUN_IDS" ]; then
              echo "ğŸ” TÃ¬m tháº¥y cÃ¡c runs cÃ³ thá»ƒ xÃ³a: $DELETABLE_RUN_IDS"
              for id in $DELETABLE_RUN_IDS; do
                echo "-> Äang xÃ³a run ID: $id"
                (yes 2>/dev/null) | gh run delete $id || echo "Lá»—i khi xÃ³a run ID $id."
              done
              echo "âœ… ÄÃ£ dá»n dáº¹p xong."
            else
              echo "ğŸ‘ KhÃ´ng cÃ³ run nÃ o cáº§n dá»n dáº¹p."
            fi
            
            echo "ğŸ”„ Chuáº©n bá»‹ cho vÃ²ng láº·p tiáº¿p theo..."
          done
