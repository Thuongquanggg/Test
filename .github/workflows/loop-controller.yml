# .github/workflows/loop-controller.yml

name: 'ðŸ”„ Looping Controller for k6 Test'

# Cho phÃ©p cháº¡y workflow nÃ y thá»§ cÃ´ng tá»« tab Actions
on:
  workflow_dispatch:

jobs:
  controller-job:
    runs-on: ubuntu-latest
    
    # QUAN TRá»ŒNG: Cáº¥p quyá»n Ä‘á»ƒ workflow nÃ y cÃ³ thá»ƒ kÃ­ch hoáº¡t workflow khÃ¡c
    permissions:
      actions: write

    steps:
      - name: 'Loop: Call k6 Test -> Wait -> Sleep 30s'
        env:
          # Cung cáº¥p token Ä‘á»ƒ GitHub CLI cÃ³ thá»ƒ xÃ¡c thá»±c
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p vÃ´ táº­n, test URL: https://certapple.com"
          while true; do
            echo ">>> [$(date)] Báº¯t Ä‘áº§u gá»i 'Test.yml'."
            
            # Lá»‡nh nÃ y sáº½:
            # 1. KÃ­ch hoáº¡t 'Test.yml'
            # 2. --ref ${{ github.ref_name }}: Cháº¡y trÃªn cÃ¹ng má»™t nhÃ¡nh
            # 3. -f target_url=...: Truyá»n input 'target_url' vÃ o workflow 'Test.yml'
            # 4. --wait: Chá» cho Ä‘áº¿n khi 'Test.yml' cháº¡y xong (hoáº·c bá»‹ timeout sau 3 phÃºt)
            gh workflow run Test.yml --ref ${{ github.ref_name }} -f target_url=https://certapple.com --wait
            
            echo ">>> [$(date)] 'Test.yml' Ä‘Ã£ cháº¡y xong. Báº¯t Ä‘áº§u nghá»‰ 30 giÃ¢y."
            sleep 30
          done
