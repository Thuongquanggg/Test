# .github/workflows/loop-controller.yml

name: 'ðŸ”„ Looping Controller for k6 Test'

on:
  workflow_dispatch:

jobs:
  controller-job:
    runs-on: ubuntu-latest
    
    permissions:
      actions: write

    steps:
      # <<< BÆ¯á»šC 1: THÃŠM BÆ¯á»šC NÃ€Y Äá»‚ Cáº¬P NHáº¬T GITHUB CLI >>>
      - name: Update GitHub CLI to the latest version
        run: |
          # CÃ¡c mÃ¡y áº£o Ubuntu cá»§a GitHub sá»­ dá»¥ng 'apt' Ä‘á»ƒ quáº£n lÃ½ gÃ³i
          sudo apt-get update
          sudo apt-get install gh -y
        # Ghi chÃº: Cáº§n `sudo` vÃ¬ chÃºng ta Ä‘ang cÃ i Ä‘áº·t/cáº­p nháº­t gÃ³i há»‡ thá»‘ng.

      # <<< BÆ¯á»šC 2: CHáº Y VÃ’NG Láº¶P Vá»šI `gh` ÄÃƒ ÄÆ¯á»¢C Cáº¬P NHáº¬T >>>
      - name: 'Loop: Call k6 Test -> Wait -> Sleep 30s'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # (TÃ¹y chá»n) Kiá»ƒm tra phiÃªn báº£n gh Ä‘á»ƒ xÃ¡c nháº­n Ä‘Ã£ cáº­p nháº­t thÃ nh cÃ´ng
          echo "GitHub CLI version: $(gh --version)"

          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p vÃ´ táº­n, test URL: https://certapple.com"
          while true; do
            echo ">>> [$(date)] Báº¯t Ä‘áº§u gá»i 'Test.yml'."
            
            # Lá»‡nh nÃ y bÃ¢y giá» sáº½ hoáº¡t Ä‘á»™ng vÃ¬ `gh` Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t
            # Äáº£m báº£o báº¡n sá»­ dá»¥ng hai dáº¥u gáº¡ch ngang "--" chá»© khÃ´ng pháº£i má»™t dáº¥u gáº¡ch dÃ i "â€“"
            gh workflow run Test.yml --ref ${{ github.ref_name }} -f target_url=https://certapple.com --wait
            
            echo ">>> [$(date)] 'Test.yml' Ä‘Ã£ cháº¡y xong. Báº¯t Ä‘áº§u nghá»‰ 30 giÃ¢y."
            sleep 30
          done
