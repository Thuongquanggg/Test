# .github/workflows/loop-controller.yml

name: 'ðŸ”„ Looping Controller for k6 Test'

on:
  workflow_dispatch:

jobs:
  controller-job:
    runs-on: ubuntu-latest
    
    permissions:
      # Váº«n cáº§n quyá»n 'actions: write' Ä‘á»ƒ kÃ­ch hoáº¡t vÃ  xem cÃ¡c workflow khÃ¡c
      actions: write

    steps:
      # ChÃºng ta khÃ´ng cáº§n cáº­p nháº­t gh ná»¯a vÃ¬ lá»—i khÃ´ng pháº£i do phiÃªn báº£n cÅ©.
      # Tuy nhiÃªn, giá»¯ láº¡i bÆ°á»›c nÃ y cÅ©ng khÃ´ng háº¡i gÃ¬.
      - name: 'Loop: Call k6 Test -> Wait -> Sleep 30s'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Báº¯t Ä‘áº§u vÃ²ng láº·p vÃ´ táº­n, test URL: https://certapple.com"
          
          while true; do
            echo ">>> [$(date)] Báº¯t Ä‘áº§u gá»i 'Test.yml'."
            
            # BÆ¯á»šC 1: KÃ­ch hoáº¡t workflow vÃ  láº¥y URL cá»§a láº§n cháº¡y má»›i.
            # Lá»‡nh nÃ y sáº½ in ra URL cá»§a láº§n cháº¡y, vÃ­ dá»¥: https://github.com/user/repo/actions/runs/12345
            RUN_URL=$(gh workflow run Test.yml --ref ${{ github.ref_name }} -f target_url=https://certapple.com)
            
            # Kiá»ƒm tra xem lá»‡nh cÃ³ cháº¡y thÃ nh cÃ´ng khÃ´ng
            if [ -z "$RUN_URL" ]; then
              echo "Lá»—i: KhÃ´ng thá»ƒ kÃ­ch hoáº¡t workflow 'Test.yml'. Dá»«ng vÃ²ng láº·p."
              exit 1
            fi
            
            echo "Workflow Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t. URL cá»§a láº§n cháº¡y: $RUN_URL"
            
            # BÆ¯á»šC 2: TrÃ­ch xuáº¥t Run ID tá»« URL.
            # Run ID lÃ  pháº§n sá»‘ á»Ÿ cuá»‘i cÃ¹ng cá»§a URL.
            RUN_ID=$(basename "$RUN_URL")
            echo "Run ID lÃ : $RUN_ID. Báº¯t Ä‘áº§u chá»..."
            
            # BÆ¯á»šC 3: DÃ¹ng 'gh run watch' Ä‘á»ƒ chá» cho Ä‘áº¿n khi láº§n cháº¡y hoÃ n thÃ nh.
            # Lá»‡nh nÃ y sáº½ tá»± Ä‘á»™ng dá»«ng khi workflow con káº¿t thÃºc (thÃ nh cÃ´ng, tháº¥t báº¡i, hoáº·c bá»‹ há»§y).
            # Cá» --exit-status sáº½ lÃ m cho lá»‡nh nÃ y tráº£ vá» mÃ£ lá»—i náº¿u workflow con tháº¥t báº¡i.
            gh run watch "$RUN_ID" --exit-status
            
            # Kiá»ƒm tra káº¿t quáº£ cá»§a láº§n cháº¡y con
            RUN_EXIT_CODE=$?
            if [ $RUN_EXIT_CODE -eq 0 ]; then
              echo ">>> [$(date)] 'Test.yml' Ä‘Ã£ cháº¡y xong vá»›i tráº¡ng thÃ¡i THÃ€NH CÃ”NG."
            else
              echo ">>> [$(date)] 'Test.yml' Ä‘Ã£ cháº¡y xong vá»›i tráº¡ng thÃ¡i THáº¤T Báº I hoáº·c Bá»Š Há»¦Y (MÃ£ lá»—i: $RUN_EXIT_CODE)."
            fi

            echo "Báº¯t Ä‘áº§u nghá»‰ 30 giÃ¢y."
            sleep 30
          done
