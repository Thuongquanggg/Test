# Tên file: .github/workflows/main-loop.yml

# Tên của workflow sẽ hiển thị trên giao diện Actions của GitHub
name: 🔁 2. Vong Lap Chinh (Chay K6)

# === PHẦN KÍCH HOẠT ===
# on: repository_dispatch sẽ khiến workflow này chạy khi nó nhận được
# một tín hiệu được gửi đến repo.
on:
  repository_dispatch:
    # Chỉ chạy khi tín hiệu có tên (type) chính xác là 'start-k6-loop'.
    types: [start-k6-loop]

# === PHẦN CÔNG VIỆC ===
jobs:
  # --- JOB 1: CHẠY CÔNG VIỆC CHÍNH ---
  run_k6_test:
    name: Chay K6 Test
    runs-on: ubuntu-latest
    # Đặt thời gian giới hạn cho job này để tránh bị treo vô hạn
    timeout-minutes: 5
    steps:
      # Bước 1: Tải mã nguồn của repo về máy ảo để có thể truy cập file k6/script.js
      - name: Tai ma nguon (Checkout)
        uses: actions/checkout@v3

      # Bước 2: Sử dụng action có sẵn của k6 để chạy bài test
      - name: Chay k6 load test
        uses: k6io/k6-action@v0.2.0
        with:
          # Chỉ định đường dẫn đến file kịch bản k6 của bạn
          filename: k6/script.js

  # --- JOB 2: KÍCH HOẠT VÒNG LẶP TIẾP THEO ---
  trigger_next_loop:
    name: Kich Hoat Vong Lap Tiep Theo
    runs-on: ubuntu-latest
    # Dòng quan trọng nhất: Job này chỉ được phép chạy SAU KHI job 'run_k6_test'
    # đã hoàn thành thành công. Điều này tạo ra chuỗi tuần tự.
    needs: run_k6_test
    steps:
      # Bước này giống hệt bước trong file start-loop.yml.
      # Nó tự gửi tín hiệu để kích hoạt lại chính workflow này, tạo ra vòng lặp.
      - name: Gui tin hieu de chay lai chinh no
        run: |
          echo "Cong viec hoan thanh. Gui tin hieu de bat dau vong lap tiep theo..."

          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_FOR_DISPATCH }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"start-k6-loop"}'
