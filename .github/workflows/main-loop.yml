# TÃªn file: .github/workflows/main-loop.yml

# TÃªn cá»§a workflow sáº½ hiá»ƒn thá»‹ trÃªn giao diá»‡n Actions cá»§a GitHub
name: ğŸ” 2. Vong Lap Chinh (Chay K6)

# === PHáº¦N KÃCH HOáº T ===
# on: repository_dispatch sáº½ khiáº¿n workflow nÃ y cháº¡y khi nÃ³ nháº­n Ä‘Æ°á»£c
# má»™t tÃ­n hiá»‡u Ä‘Æ°á»£c gá»­i Ä‘áº¿n repo.
on:
  repository_dispatch:
    # Chá»‰ cháº¡y khi tÃ­n hiá»‡u cÃ³ tÃªn (type) chÃ­nh xÃ¡c lÃ  'start-k6-loop'.
    types: [start-k6-loop]

# === PHáº¦N CÃ”NG VIá»†C ===
jobs:
  # --- JOB 1: CHáº Y CÃ”NG VIá»†C CHÃNH ---
  run_k6_test:
    name: Chay K6 Test
    runs-on: ubuntu-latest
    # Äáº·t thá»i gian giá»›i háº¡n cho job nÃ y Ä‘á»ƒ trÃ¡nh bá»‹ treo vÃ´ háº¡n
    timeout-minutes: 5
    steps:
      # BÆ°á»›c 1: Táº£i mÃ£ nguá»“n cá»§a repo vá» mÃ¡y áº£o Ä‘á»ƒ cÃ³ thá»ƒ truy cáº­p file k6/script.js
      - name: Tai ma nguon (Checkout)
        uses: actions/checkout@v3

      # BÆ°á»›c 2: Sá»­ dá»¥ng action cÃ³ sáºµn cá»§a k6 Ä‘á»ƒ cháº¡y bÃ i test
      - name: Chay k6 load test
        uses: k6io/k6-action@v0.2.0
        with:
          # Chá»‰ Ä‘á»‹nh Ä‘Æ°á»ng dáº«n Ä‘áº¿n file ká»‹ch báº£n k6 cá»§a báº¡n
          filename: k6/script.js

  # --- JOB 2: KÃCH HOáº T VÃ’NG Láº¶P TIáº¾P THEO ---
  trigger_next_loop:
    name: Kich Hoat Vong Lap Tiep Theo
    runs-on: ubuntu-latest
    # DÃ²ng quan trá»ng nháº¥t: Job nÃ y chá»‰ Ä‘Æ°á»£c phÃ©p cháº¡y SAU KHI job 'run_k6_test'
    # Ä‘Ã£ hoÃ n thÃ nh thÃ nh cÃ´ng. Äiá»u nÃ y táº¡o ra chuá»—i tuáº§n tá»±.
    needs: run_k6_test
    steps:
      # BÆ°á»›c nÃ y giá»‘ng há»‡t bÆ°á»›c trong file start-loop.yml.
      # NÃ³ tá»± gá»­i tÃ­n hiá»‡u Ä‘á»ƒ kÃ­ch hoáº¡t láº¡i chÃ­nh workflow nÃ y, táº¡o ra vÃ²ng láº·p.
      - name: Gui tin hieu de chay lai chinh no
        run: |
          echo "Cong viec hoan thanh. Gui tin hieu de bat dau vong lap tiep theo..."

          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_FOR_DISPATCH }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"start-k6-loop"}'
